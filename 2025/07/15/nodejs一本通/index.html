<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    
    
    <title>nodejs一本通 | Yoyo&#39;s blog</title>
    
    <link rel="alternative" href="/atom.xml" title="Yoyo&#39;s blog" type="application/atom+xml">
    
    
<link rel="stylesheet" href="/css/style.css">

    
    <link rel="stylesheet" href="/libs/fancybox/jquery.fancybox.css" charset="utf-8">
    
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<!-- hexo injector head_end start --><script src="./func.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>
<body class="site">
    <!-- 遮罩层 -->
    <div id="mask-layer">
    </div>
    
    <header class="site-header">
        <h1 class="site-title"><a href="/">Yoyo&#39;s blog</a></h1>
        <nav class="site-nav">
            <ul class="nav">
                
                <li><a href="/">Home</a></li>
                
                <li><a href="/archives">Archives</a></li>
                
                
                <li><a href="/atom.xml" title="RSS Feed">rss</a></li>
                
                <li><a class="toggle-search" href="#search">search</a></li>
            </ul>
        </nav>
        <div class="site-search" id="search">
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://70v-yoyo.github.io"></form>
        </div>
        
            <div class="site-header-background" style="background-image:url('http://reumia.github.io/hexo-theme-zzoman2015/images/background-zzoman2015.jpg')"></div>
        
    </header>
    <div class="site-body">
        <div class="global-width">
    <article class="article" data-layout="post" data-slug="nodejs一本通">
        <div class="article-content">
            
            
            <header class="article-header">
                <div class="article-meta">
                    <a href="/2025/07/15/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A/" class="article-date">
  <time datetime="2025-07-15T13:50:13.000Z">2025-07-15</time>
</a>
                    
                    
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/frontend/" rel="tag">frontend</a></li></ul>

                </div>
                
    <h1 class="article-title" itemprop="name">
      <a href="/2025/07/15/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A/">nodejs一本通</a>
    </h1>

            </header>
            
            <div class="article-body">
                <meta name="referrer" content="no-referrer" />

<blockquote>
<p>版本：20250715</p>
</blockquote>
<ul>
<li>链接<br><a target="_blank" rel="noopener" href="https://wyoyo.blog.csdn.net/article/details/149348790?fromshare=blogdetail&sharetype=blogdetail&sharerId=149348790&sharerefer=PC&sharesource=qq_41775119&sharefrom=from_link">nodejs模块大全</a></li>
</ul>
<h1 id="实用模块-工具"><a href="#实用模块-工具" class="headerlink" title="实用模块&#x2F;工具"></a>实用模块&#x2F;工具</h1><table>
<thead>
<tr>
<th>模块</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>jsonwebtoken</code></td>
<td>JWT 登录鉴权（签发和验证）</td>
</tr>
<tr>
<td><code>cors</code></td>
<td>解决跨域请求问题</td>
</tr>
<tr>
<td><code>dotenv</code></td>
<td>使用 <code>.env</code> 文件管理配置</td>
</tr>
<tr>
<td><code>axios</code></td>
<td>在 Node 中发起请求（后端调用第三方接口）</td>
</tr>
<tr>
<td><code>multer</code></td>
<td>上传文件（表单文件）</td>
</tr>
<tr>
<td><code>cookie-parser</code></td>
<td>操作 Cookie（登录相关）</td>
</tr>
<tr>
<td><code>child_process</code></td>
<td>执行命令</td>
</tr>
<tr>
<td><code>events</code></td>
<td>事件系统</td>
</tr>
<tr>
<td><code>stream</code></td>
<td>大文件处理、管道、压缩</td>
</tr>
<tr>
<td><code>Buffer</code></td>
<td>二进制操作、音视频、协议层</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>需求</th>
<th>推荐库&#x2F;工具</th>
</tr>
</thead>
<tbody><tr>
<td>Web 框架</td>
<td><code>Express</code>, <code>Koa</code>, <code>Fastify</code></td>
</tr>
<tr>
<td>数据库 ORM</td>
<td><code>Sequelize</code>, <code>Prisma</code>, <code>Mongoose</code></td>
</tr>
<tr>
<td>环境变量</td>
<td><code>dotenv</code></td>
</tr>
<tr>
<td>单测</td>
<td><code>Jest</code>, <code>Mocha</code>, <code>Supertest</code></td>
</tr>
<tr>
<td>部署</td>
<td><code>PM2</code>, <code>Docker</code>, <code>Vercel</code>, <code>Render</code></td>
</tr>
</tbody></table>
<h1 id="复习"><a href="#复习" class="headerlink" title="复习"></a>复习</h1><ol>
<li>为什么JS可以在浏览器中执行<br>原理：待执行JS代码-&gt;JS解析引擎<br>不同浏览器使用不同的 JavaScript 解析引擎：Chrome 浏览器的 V8 解析引擎性能最好<br> Chrome 浏览器  &#x3D;&gt;  V8<br> Firefox 浏览器    &#x3D;&gt;  OdinMonkey（奥丁猴）<br> Safari 浏览器        &#x3D;&gt;  JSCore<br> IE 浏览器            &#x3D;&gt;  Chakra（查克拉）</li>
<li>为什么 JavaScript 可以操作 DOM 和 BOM<br>每个浏览器都内置 DOM、BOM API </li>
<li>浏览器中JS运行环境<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/3570a0179c7e46c7bb1639619d57e932.png" alt="在这里插入图片描述"></li>
</ol>
<h1 id="基础语法-环境"><a href="#基础语法-环境" class="headerlink" title="基础语法 &amp; 环境"></a>基础语法 &amp; 环境</h1><ul>
<li>推荐的项目结构分层</li>
</ul>
<table>
<thead>
<tr>
<th>层级</th>
<th>职责</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>router（路由层）</td>
<td>导出router：接收请求，转发给 controller</td>
<td><code>/user/:id</code></td>
</tr>
<tr>
<td>controller（控制器）</td>
<td>处理请求参数、返回响应</td>
<td>调用 service、处理错误</td>
</tr>
<tr>
<td>service（业务层）</td>
<td>写具体逻辑或数据库操作</td>
<td><code>User.findById(id)</code></td>
</tr>
<tr>
<td>model（模型层）</td>
<td>定义数据结构</td>
<td>Mongoose 模型</td>
</tr>
<tr>
<td>middleware（中间件层）</td>
<td>登录验证、错误处理等</td>
<td><code>auth.js</code>、<code>error.js</code></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">├── app.js</span><br><span class="line">├── routes/</span><br><span class="line">│   └── user.js</span><br><span class="line">├── controllers/</span><br><span class="line">│   └── userController.js</span><br><span class="line">├── services/</span><br><span class="line">│   └── userService.js</span><br><span class="line">├── models/</span><br><span class="line">│   └── user.js</span><br><span class="line">├── middleware/</span><br><span class="line">│   ├── auth.js</span><br><span class="line">│   └── errorHandler.js</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>定义<br>Node.js 是基于 Chrome V8 引擎的 JavaScript 运行环境。<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/">nodejs官网</a><br> Node.js 用作中间件。例如：在浏览器端和 Java 端使用 Node.js 作为中间件，Node.js 调用 Java 后端发布的接口，同时 Node.js 可以发布 HTTP 接口给浏览器端调用。<br> 默认使用 CommonJS 模块规范</li>
<li>优点</li>
</ul>
<ol>
<li>高并发能力。在 Java、PHP 或者 .Net 等服务端语言中，会为每一个客户端的连接创建一个新的线程，而每个线程需要耗费大约 2 MB 内存。也就是说，理论上一个 8GB 的服务器，可以同时连接的最大用户数为 4000 个左右。而 Node.js 不会为每个客户创建新的线程，仅仅使用一个线程。所以，使用 Node.js，一个 8GB 的服务器，可以同时处理超过 4 万用户的连接。</li>
<li>高性能服务器。Node.js 基于 V8 引擎，V8 引擎是 Google 公司使用 C++ 开发的一种高性能引擎。与开发者编写的低端的 C 语言具有非常相近的执行效率。</li>
<li>强大的工具和框架：<br>基于 Express 框架（<a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/%EF%BC%89%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BA">http://www.expressjs.com.cn/）快速构建</a> Web 应用<br>基于 Electron 框架（<a target="_blank" rel="noopener" href="https://electronjs.org/%EF%BC%89%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%9A%84%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8">https://electronjs.org/）跨平台的桌面应用</a><br>基于 restify 框架（<a target="_blank" rel="noopener" href="http://restify.com/%EF%BC%89%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BA">http://restify.com/）快速构建</a> API 接口项目<br>读写和操作数据库、创建实用的命令行工具辅助前端开发</li>
</ol>
<table>
<thead>
<tr>
<th><strong>工具&#x2F;框架</strong></th>
<th><strong>简介</strong></th>
<th><strong>特点</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Express.js</strong></td>
<td>用于构建Web应用和API的轻量级框架</td>
<td>简洁、快速、支持RESTful API、强大的路由功能</td>
</tr>
<tr>
<td><strong>NestJS</strong></td>
<td>基于TypeScript的现代化Node.js框架，适用于企业级应用</td>
<td>支持TypeScript、模块化架构、易于集成各种库</td>
</tr>
<tr>
<td><strong>Koa.js</strong></td>
<td>由Express原班人马开发的框架，目标是更小更强大</td>
<td>支持async&#x2F;await、灵活的中间件机制</td>
</tr>
<tr>
<td><strong>Socket.io</strong></td>
<td>实现实时、双向通信的JavaScript库</td>
<td>支持WebSocket、易于集成、支持广播和房间功能</td>
</tr>
<tr>
<td><strong>Electron.js</strong></td>
<td>使用Web技术构建跨平台桌面应用</td>
<td>跨平台、支持丰富的原生API</td>
</tr>
<tr>
<td><strong>PM2</strong></td>
<td>Node.js进程管理工具，支持生产环境的应用管理</td>
<td>进程管理、负载均衡、日志管理、性能监控</td>
</tr>
<tr>
<td><strong>Mongoose</strong></td>
<td>MongoDB的ODM库，简化与MongoDB的交互</td>
<td>Schema支持、数据验证、查询构建、模型功能强大</td>
</tr>
</tbody></table>
<ul>
<li>Node 和浏览器的区别<br>浏览器是 JavaScript 的前端运行环境。<br>Node.js 是 JavaScript 的后端运行环境。无法调用 DOM 和 BOM 等浏览器内置 API。</li>
<li>安装运行<br>LTS是长期稳定版 企业项目推荐安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v <span class="comment">#查看版本</span></span><br><span class="line">node xx.js <span class="comment">#运行某个nodejs文件</span></span><br></pre></td></tr></table></figure>
<h1 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h1><p> require 和 module.exports（CommonJS）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">a, b</span>) =&gt; a + b;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  add</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; add &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./math&#x27;</span>);<span class="comment">//同步 加载阻塞执行</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><ul>
<li>加载模块<br>require方法加载执行这个模块代码。<br>模块的加载机制：<ol>
<li>优先从缓存中加载。模块第一次加载后会缓存，即多次调用require()并不会使模块代码被执行多次。提高加载效率。</li>
<li>内置模块的加载优先级最高。require(‘fs’) 始终返回内置的 fs 模块，即使在 node_modules 目录下有名字相同的包也叫做 fs。</li>
<li>自定义模块加载：require() 加载自定义模块必须指定以 .&#x2F; 或 ..&#x2F; 开头路径标识符。如果没有，则 node 会把它当作内置模块或第三方模块加载。</li>
<li>第三方模块加载：如果不是一个内置模块，也没有以 ‘.&#x2F;’ 或 ‘..&#x2F;’ 开头，则 Node.js 会从当前模块父目录开始，尝试从 &#x2F;node_modules 文件夹中加载第三方模块。<br>如果没有找到，则移动到再上一层父目录中，直到文件系统的根目录。</li>
<li>目录作为模块：三种加载方式：<br>目录下查找 package.json 的文件，并寻找 main 属性，作为 require() 加载入口<br>如果目录里没有 package.json 文件，或者 main 入口不存在或无法解析，则 Node.js 试图加载目录下 index.js 文件。<br>如果以上两步都失败，则在终端打印错误消息，Error: Cannot find module ‘xxx’</li>
<li>require() 导入自定义模块，如果省略文件扩展名，则按顺序分别尝试加载以下的文件：<br>按照确切文件名加载<br>补全 .js 扩展名进行加载<br>补全 .json 扩展名进行加载<br>补全 .node 扩展名进行加载<br>加载失败，终端报错</li>
</ol>
</li>
<li>模块有模块作用域，防止全局变量污染。每个.js自定义模块都有一个module对象，存储有关信息。</li>
<li>module.exports 对象<br>自定义模块中使用 module.exports 对象，将模块内成员共享出去，供外界使用。外界用 require() 导入自定义模块时，得到 module.exports 所指向的对象。</li>
<li>exports 对象<br>简化。默认exports 和 module.exports 指向同一个对象。最终共享结果以 module.exports 指向的对象为准。</li>
<li>exports 和 module.exports 的使用误区<br>require() 模块时永远是 module.exports 指向的对象<br>注意：为了防止混乱，建议大家不要在同一个模块中同时使用 exports 和 module.exports<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/43c7d2d7f8904ef6a4f748a8fcddb714.png" alt="在这里插入图片描述"></li>
<li>Node.js 中的模块化规范<br>Node.js 遵循CommonJS 模块化规范<br>CommonJS 规定：每个模块内部 module对象代表当前模块，exports 属性（即 module.exports）是对外接口。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)<span class="comment">//导入内置模块</span></span><br><span class="line"><span class="keyword">const</span> custom=<span class="built_in">require</span>(<span class="string">&#x27;./custom.js&#x27;</span>)<span class="comment">//导入用户自定义模块</span></span><br><span class="line"><span class="keyword">const</span> moment=<span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)<span class="comment">//导入第三方模块</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(http,custom,moment)<span class="comment">//打印的是他们的module.exports内容</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./modA&#x27;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./modB&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main module:&#x27;</span>, <span class="variable language_">module</span>);</span><br><span class="line"><span class="comment">//module 不会 直接包含 require(&#x27;./modA&#x27;) 和 require(&#x27;./modB&#x27;) 的详细信息</span></span><br><span class="line"><span class="comment">//但它间接包含子模块的信息 —— 体现在 module.children 属性里。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//modA.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; <span class="attr">myModule</span>: <span class="variable language_">module</span> &#125;;</span><br><span class="line"><span class="comment">//modB.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; <span class="attr">myModule</span>: <span class="variable language_">module</span> &#125;;</span><br><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="keyword">const</span> modA = <span class="built_in">require</span>(<span class="string">&#x27;./modA&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> modB = <span class="built_in">require</span>(<span class="string">&#x27;./modB&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;modA module:&#x27;</span>, modA.<span class="property">myModule</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;modB module:&#x27;</span>, modB.<span class="property">myModule</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main module:&#x27;</span>, <span class="variable language_">module</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用moment包  npm安装moment</span></span><br><span class="line"><span class="keyword">const</span> moment=<span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)<span class="comment">//导入第三方模块</span></span><br><span class="line"><span class="keyword">const</span> dt=<span class="title function_">moment</span>().<span class="title function_">format</span>(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dt)</span><br></pre></td></tr></table></figure>
<h3 id="启用ES6模块化支持"><a href="#启用ES6模块化支持" class="headerlink" title="启用ES6模块化支持"></a>启用ES6模块化支持</h3><ul>
<li>ES 模块 import&#x2F;export 在 Node 中的使用（.mjs、type: “module”）<br>为啥要转ES模块？与浏览器一致、静态分析优势<br>使用：将扩展名从<code>.js</code>改为<code>.mjs</code>；package.json中添加<code>type: &quot;module&quot;</code></li>
<li>引入模块<br><code>import express from &#39;express</code>替代之前的require</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> userRouter <span class="keyword">from</span> <span class="string">&#x27;./router/user_router.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, userRouter)<span class="comment">//挂载路由器</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//router.js</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getAllUser &#125; <span class="keyword">from</span> <span class="string">&#x27;../controller/user_ctrl.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> express.<span class="title class_">Router</span>()</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, getAllUser)<span class="comment">//第二个是回调函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br><span class="line"><span class="comment">//router_handler.js</span></span><br><span class="line"><span class="keyword">import</span> db <span class="keyword">from</span> <span class="string">&#x27;../db/index.js&#x27;</span></span><br><span class="line"><span class="comment">// 使用 ES6 的按需导出语法，将 getAllUser 方法导出出去</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAllUser</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [rows] = <span class="keyword">await</span> db.<span class="title function_">query</span>(<span class="string">&#x27;select id, username, nickname, xxx from ev_users&#x27;</span>)</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;获取用户列表数据成功！&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: rows,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;<span class="comment">//try...catch捕获异常</span></span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;获取用户列表数据失败！&#x27;</span>,</span><br><span class="line">      <span class="attr">desc</span>: err.<span class="property">message</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//db_index.js</span></span><br><span class="line"><span class="keyword">import</span> mysql <span class="keyword">from</span> <span class="string">&#x27;mysql2&#x27;</span></span><br><span class="line"><span class="keyword">const</span> pool = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&#x27;my_db_01&#x27;</span>,</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&#x27;admin123&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> pool.<span class="title function_">promise</span>()</span><br></pre></td></tr></table></figure>
<h1 id="路径处理模块-path"><a href="#路径处理模块-path" class="headerlink" title="路径处理模块 path"></a>路径处理模块 path</h1><p>Node 路径不能直接用 + 拼，需用 path 保证跨平台正确性。</p>
<ul>
<li>路径动态拼接的问题<br>在使用 fs 模块操作文件时，如果提供的操作路径是以 .&#x2F; 或 ..&#x2F; 开头的相对路径时，容易出现路径动态拼接错误的问题。<br>原因：代码在运行的时候，会以执行 node 命令时所处的目录，动态拼接出被操作文件的完整路径。<br>解决方案：在使用 fs 模块操作文件时，直接提供完整的路径，不要提供 .&#x2F; 或 ..&#x2F; 开头的相对路径，从而防止路径动态拼接的问题。<br>__dirname 是 Node.js 全局变量，表示当前模块（文件）所在目录的绝对路径，用于拼接路径</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__dirname: /Users/yourname/project</span></span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(__dirname+<span class="string">&#x27;/path.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>,<span class="keyword">function</span>(<span class="params">err,datastr</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件读取失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">	<span class="comment">//err=null时读取成功，反之读取失败</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(datastr)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">__dirname 是当前文件夹路径（不是工作目录）</span></span><br><span class="line"><span class="comment">path.resolve()：返回绝对路径</span></span><br><span class="line"><span class="comment">path.join()：拼路径，自动处理斜杠</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="comment">// 获取绝对路径</span></span><br><span class="line"><span class="keyword">const</span> abs = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;test.txt&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(abs); <span class="comment">// /xxx/data/test.tx</span></span><br><span class="line"><span class="comment">// 拼接路径</span></span><br><span class="line"><span class="keyword">const</span> full = path.<span class="title function_">join</span>(<span class="string">&#x27;/a&#x27;</span>, <span class="string">&#x27;/b&#x27;</span>, <span class="string">&#x27;c.txt&#x27;</span>); <span class="comment">// /a/b/c.txt</span></span><br><span class="line"></span><br><span class="line">path.<span class="title function_">join</span>([...paths])<span class="comment">//多个路径片段连接</span></span><br><span class="line"></span><br><span class="line">path.<span class="title function_">basename</span>(path,[ext])</span><br><span class="line"><span class="comment">//获取路径的最后一部分，用于获取路径中的文件名</span></span><br><span class="line"><span class="comment">//ext 可选，文件扩展名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fpath=<span class="string">&#x27;/a/b/c/index.html&#x27;</span></span><br><span class="line"><span class="keyword">var</span> filename=path.<span class="title function_">basename</span>(fpath)<span class="comment">//index.html</span></span><br><span class="line"><span class="keyword">var</span> name_without_ext=path.<span class="title function_">basename</span>(fpath,<span class="string">&#x27;.html&#x27;</span>)<span class="comment">//index</span></span><br><span class="line">path.<span class="title function_">extname</span>(path)<span class="comment">//获取扩展名部分</span></span><br><span class="line"><span class="keyword">const</span> fext=path.<span class="title function_">extname</span>(fpath)</span><br></pre></td></tr></table></figure>
<h1 id="文件系统模块-fs"><a href="#文件系统模块-fs" class="headerlink" title="文件系统模块 fs"></a>文件系统模块 fs</h1><p>fs.writeFile() 方法只能用来创建文件，不能用来创建路径<br>重复调用 fs.writeFile() 写入同一个文件，新写入内容会覆盖之前的旧内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步读写（适合 CLI 脚本）</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>);       <span class="comment">// 写文件</span></span><br><span class="line"><span class="keyword">const</span> content = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;data.txt&#x27;</span>); <span class="comment">// 读文件</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(content.<span class="title function_">toString</span>());             <span class="comment">// Buffer 转字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步读写（适合服务端）</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="property">promises</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">readData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> fs.<span class="title function_">readFile</span>(<span class="string">&#x27;data.txt&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">readData</span>();</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(path,[options],callback)<span class="comment">//callback回调函数</span></span><br><span class="line"><span class="comment">//参数2 可选 编码格式</span></span><br><span class="line"><span class="comment">//参数3 文件读取完成，通过回调函数拿到读取结果</span></span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;./path.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>,<span class="keyword">function</span>(<span class="params">err,datastr</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件读取失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">	<span class="comment">//err=null时读取成功，反之读取失败,datastr=undefined</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(datastr)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">writeFile</span>(file_path,data.[options],callback)</span><br><span class="line"><span class="comment">//data 要写入file的内容</span></span><br><span class="line"><span class="comment">//callback 文件写入完成后的回调函数</span></span><br><span class="line"><span class="comment">//是否写入成功也是判断err</span></span><br></pre></td></tr></table></figure>
<ul>
<li>实例：将html文件中的js css部分拆出来成一单独文件</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[\s\S]</span> 只匹配 一个字符；</span><br><span class="line"><span class="string">[\s\S]</span>* 才是匹配 任意数量的字符（包括 <span class="number">0</span> 个）；</span><br><span class="line"><span class="string">[\s\S]</span>*? 是非贪婪地匹配任意数量字符，直到匹配到后续的模式。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs=<span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> regStyle=<span class="regexp">/&lt;style&gt;[\s\S]*&lt;\/style&gt;/</span></span><br><span class="line"><span class="keyword">const</span> regScript=<span class="regexp">/&lt;script&gt;[\s\S]*&lt;\/script&gt;/</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;index.html&#x27;</span>),<span class="string">&#x27;utf8&#x27;</span>,<span class="function">(<span class="params">err,datastr</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件读取失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="title function_">resolveCSS</span>(datastr)</span><br><span class="line">	<span class="title function_">resolveJS</span>(datastr)</span><br><span class="line">	<span class="title function_">resolveHTML</span>(datastr)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveCSS</span>(<span class="params">htmlstr</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> r1=regStyle.<span class="title function_">exec</span>(htmlstr)</span><br><span class="line">	<span class="keyword">const</span> newcss=r1[<span class="number">0</span>].<span class="title function_">replace</span>(<span class="string">&#x27;&lt;style&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;&lt;/style&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	fs.<span class="title function_">writeFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;index.css&#x27;</span>),newcss,<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件写入失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;css写入成功&#x27;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveJS</span>(<span class="params">htmlstr</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> r2=regScript.<span class="title function_">exec</span>(htmlstr)</span><br><span class="line">	<span class="keyword">const</span> newjs=r2[<span class="number">0</span>].<span class="title function_">replace</span>(<span class="string">&#x27;&lt;script&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;&lt;/script&gt;&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	fs.<span class="title function_">writeFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;./index.js&#x27;</span>),newjs,<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件写入失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;js写入成功&#x27;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveHTML</span>(<span class="params">htmlstr</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> newhtml=htmlstr.<span class="title function_">replace</span>(regStyle,<span class="string">&#x27;&lt;link rel=&quot;stylesheet&quot; href=&quot;./index.css&quot;/&gt;&#x27;</span>).<span class="title function_">replace</span>(regScript,<span class="string">&#x27;&lt;script src=&quot;./index.js&quot;&gt;&lt;/script&gt;&#x27;</span>)</span><br><span class="line">	fs.<span class="title function_">writeFile</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;./index.html&#x27;</span>),newhtml,<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件写入失败&#x27;</span>+err.<span class="property">message</span>)</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;html写入成功&#x27;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h1><blockquote>
<p>nvm是用来切换nodejs版本的</p>
<p>v14之前，由于 node.js 官方提供的 fs 模块仅支持以回调函数的方式读取文件，不支持 Promise 的调用方式。需要安装 then-fs 这个第三方包<code>npm install then-fs</code>，支持基于 Promise 方式读取文件的内容<br>调用 then-fs 提供的 readFile() 方法，可以异步地读取文件的内容，它的返回值是 Promise 实例对象，可以调用 .then() 方法为每个 Promise 异步操作指定成功和失败之后的回调函数。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thenFs <span class="keyword">from</span> <span class="string">&#x27;then-fs&#x27;</span></span><br><span class="line">thenFs.<span class="title function_">readFile</span>(<span class="string">&#x27;./1.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(res)&#125;,<span class="function"><span class="params">err</span>=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;err&#x27;</span>,err)&#125;)</span><br><span class="line"><span class="comment">//err失败回调可选的</span></span><br><span class="line">thenFs.<span class="title function_">readFile</span>(<span class="string">&#x27;./1.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(res)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果有多个这样的读取，要保证文件的读取顺序，需要用链式调用</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">如果上一个 .then() 方法中返回了一个新的 Promise 实例对象，则可以通过下一个 .then() 继续进行处理。通过 .then() 方法的链式调用，就解决了回调地狱的问题。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">thenFs.<span class="title function_">readFile</span>(<span class="string">&#x27;./1.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>)<span class="comment">//返回promise实例对象</span></span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123; <span class="comment">//捕获错误</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">r1</span>)=&gt;</span>&#123;<span class="comment">//指定成功的回调函数</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(r1)</span><br><span class="line">	<span class="keyword">return</span> thenFs.<span class="title function_">readFile</span>(<span class="string">&#x27;./2.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">r2</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(r2)</span><br><span class="line">	<span class="keyword">return</span> thenFs.<span class="title function_">readFile</span>(<span class="string">&#x27;./3.txt&#x27;</span>,<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">r3</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(r3)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123; <span class="comment">//捕获错误</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Node.js  fs.promises API 到 Node.js v14 起正式推荐使用，<code>const fs = require(&#39;fs&#39;).promises;</code>引入后就可以开始使用了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="property">promises</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">readFilesInOrder</span>(<span class="params">files</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> results = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> file <span class="keyword">of</span> files) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> content = <span class="keyword">await</span> fs.<span class="title function_">readFile</span>(file, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`内容 (<span class="subst">$&#123;file&#125;</span>):\n`</span>, content);</span><br><span class="line">      results.<span class="title function_">push</span>(content);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`读取 <span class="subst">$&#123;file&#125;</span> 出错:`</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例文件名数组</span></span><br><span class="line"><span class="keyword">const</span> fileList = [<span class="string">&#x27;file1.txt&#x27;</span>, <span class="string">&#x27;file2.txt&#x27;</span>, <span class="string">&#x27;file3.txt&#x27;</span>];</span><br><span class="line"><span class="title function_">readFilesInOrder</span>(fileList).<span class="title function_">then</span>(<span class="function"><span class="params">contents</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\n所有文件读取完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//更喜欢用 .then() 链式写法（不使用 async/await）</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>).<span class="property">promises</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readFilesInOrder</span>(<span class="params">files</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  <span class="keyword">const</span> results = [];</span><br><span class="line"></span><br><span class="line">  files.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    promise = promise</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> fs.<span class="title function_">readFile</span>(file, <span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`内容 (<span class="subst">$&#123;file&#125;</span>):\n`</span>, content);</span><br><span class="line">        results.<span class="title function_">push</span>(content);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`读取 <span class="subst">$&#123;file&#125;</span> 出错:`</span>, err));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise.<span class="title function_">then</span>(<span class="function">() =&gt;</span> results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">readFilesInOrder</span>(fileList).<span class="title function_">then</span>(<span class="function"><span class="params">contents</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\n所有文件读取完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initp</span>(<span class="params">fpath</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">        fs.<span class="title function_">readFile</span>(fpath, <span class="string">&#x27;utf8&#x27;</span>, <span class="function">(<span class="params">err, dataStr</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(err);      <span class="comment">// 读取失败，触发 fail 回调</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(dataStr); <span class="comment">// 可选：打印内容</span></span><br><span class="line">                <span class="title function_">resolve</span>(dataStr);     <span class="comment">// 成功，触发 suc 回调</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">suc</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;成功回调函数触发：&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params">err</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;失败回调函数触发：&quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">initp</span>(<span class="string">&#x27;./1.txt&#x27;</span>).<span class="title function_">then</span>(suc, fail);</span><br></pre></td></tr></table></figure>
<h1 id="进程信息：process"><a href="#进程信息：process" class="headerlink" title="进程信息：process"></a>进程信息：process</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">argv</span>); <span class="comment">// 获取命令行参数</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>);  <span class="comment">// 获取环境变量</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">cwd</span>()); <span class="comment">// 当前工作目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//命令行传参</span></span><br><span class="line">node mytool.<span class="property">js</span> build</span><br><span class="line"><span class="keyword">const</span> command = process.<span class="property">argv</span>[<span class="number">2</span>]; <span class="comment">// &quot;build&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;你输入了命令：&#x27;</span>, command);</span><br></pre></td></tr></table></figure>
<h1 id="系统信息：os-模块"><a href="#系统信息：os-模块" class="headerlink" title="系统信息：os 模块"></a>系统信息：os 模块</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(os.<span class="title function_">platform</span>());   <span class="comment">// 操作系统</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(os.<span class="title function_">cpus</span>().<span class="property">length</span>); <span class="comment">// CPU 核心数</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(os.<span class="title function_">homedir</span>());    <span class="comment">// 用户主目录</span></span><br></pre></td></tr></table></figure>
<ul>
<li>总结</li>
</ul>
<table>
<thead>
<tr>
<th>主题</th>
<th>常用 API &#x2F; 技能点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>模块化</strong></td>
<td><code>require</code>、<code>exports</code>、<code>module.exports</code>、ESM 支持（了解 <code>type: &quot;module&quot;</code>）</td>
</tr>
<tr>
<td><strong>路径处理</strong></td>
<td><code>path.resolve</code>、<code>path.join</code></td>
</tr>
<tr>
<td><strong>文件操作</strong></td>
<td><code>fs.readFileSync</code>、<code>fs.writeFileSync</code>、<code>fs.promises</code> 版本</td>
</tr>
<tr>
<td><strong>系统信息</strong></td>
<td><code>os.platform()</code>、<code>os.cpus()</code>、<code>os.homedir()</code></td>
</tr>
<tr>
<td><strong>进程参数</strong></td>
<td><code>process.argv</code>、<code>process.cwd()</code>、<code>process.env</code>（常用于配置）</td>
</tr>
</tbody></table>
<h1 id="HTTP-服务基础"><a href="#HTTP-服务基础" class="headerlink" title="HTTP 服务基础"></a>HTTP 服务基础</h1><ul>
<li>Node 原生 http 模块有哪些缺点？无内置路由、中间件、请求体解析、参数处理，需要框架辅助（如 Express）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;Hello, Node.js Server!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running at http://localhost:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理不同路由 原生 HTTP 没有路由机制，需要手动判断 url 和 method</span></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; url, method &#125; = req;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (url === <span class="string">&#x27;/&#x27;</span> &amp;&amp; method === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;Home Page&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url === <span class="string">&#x27;/about&#x27;</span> &amp;&amp; method === <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;About Page&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="property">statusCode</span> = <span class="number">404</span>;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;Not Found&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置响应头 &amp; 状态码</span></span><br><span class="line">res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">  <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">res.<span class="title function_">end</span>(<span class="string">&#x27;&lt;h1&gt;Hello&lt;/h1&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">res.<span class="property">statusCode</span> = <span class="number">200</span>;</span><br><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>);</span><br><span class="line">res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">msg</span>: <span class="string">&#x27;Hello&#x27;</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理 POST 请求体 </span></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//POST 请求体数据是异步流，通过 req.on(&#x27;data&#x27;) 收集</span></span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; req.<span class="property">url</span> === <span class="string">&#x27;/echo&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">chunk</span> =&gt;</span> &#123;<span class="comment">//监听事件 chunk是传过来的数据块</span></span><br><span class="line">      body += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>);</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">received</span>: body</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 实例：实现clock时钟的web服务器</span></span><br><span class="line"><span class="comment">把文件的实际存放路径，作为每个资源的请求 url 地址。*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs=<span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> server=http.<span class="title function_">createServer</span>()</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> url=req.<span class="property">url</span></span><br><span class="line">	<span class="keyword">let</span> fpath=<span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="comment">//const fpath=path.join(__dirname,url)</span></span><br><span class="line">	<span class="keyword">if</span>(url===<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">		fpath=path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;./clock/index.html&#x27;</span>)</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		fpath=path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;./clock&#x27;</span>,url)</span><br><span class="line">	&#125;</span><br><span class="line">	fs.<span class="title function_">readFile</span>(fpath,<span class="string">&#x27;utf8&#x27;</span>,<span class="function">(<span class="params">err,datastr</span>)=&gt;</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)<span class="keyword">return</span> res.<span class="title function_">end</span>(<span class="string">&#x27;404 not found&#x27;</span>)</span><br><span class="line">		res.<span class="title function_">end</span>(datastr)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">80</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*举例子</span></span><br><span class="line"><span class="comment">写一个原生 Node HTTP 服务，监听端口 5000，支持：</span></span><br><span class="line"><span class="comment">GET /hello 返回 “Hello”</span></span><br><span class="line"><span class="comment">GET /now 返回当前时间 JSON 格式</span></span><br><span class="line"><span class="comment">POST /name 返回你 POST 的 name 内容（例如：&#123;&quot;name&quot;:&quot;Tom&quot;&#125;）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> server=http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.<span class="property">method</span>===<span class="string">&#x27;GET&#x27;</span>&amp;&amp;req.<span class="property">url</span>===<span class="string">&#x27;/hello&#x27;</span>)&#123;</span><br><span class="line">        res.<span class="title function_">end</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(req.<span class="property">method</span>===<span class="string">&#x27;GET&#x27;</span>&amp;&amp;req.<span class="property">url</span>===<span class="string">&#x27;/now&#x27;</span>)&#123;</span><br><span class="line">        res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">        res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;<span class="string">&#x27;time&#x27;</span>:<span class="keyword">new</span> <span class="title class_">Date</span>()&#125;))   </span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(req.<span class="property">method</span>===<span class="string">&#x27;POST&#x27;</span>&amp;&amp;req.<span class="property">url</span>===<span class="string">&#x27;/name&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> body=<span class="string">&#x27;&#x27;</span></span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>,<span class="function"><span class="params">chunk</span>=&gt;</span>&#123;</span><br><span class="line">            body+=chunk</span><br><span class="line">        &#125;)</span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;application/json&#x27;</span>);</span><br><span class="line">            res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                <span class="attr">receive</span>:<span class="title class_">JSON</span>.<span class="title function_">parse</span>(body)[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">5000</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;running...&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 web 服务器的基本步骤<br>导入 http 模块<br>创建 web 服务器实例<br>为服务器实例绑定 request 事件，监听客户端的请求<br>启动服务器</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http=<span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)<span class="comment">//导入</span></span><br><span class="line"><span class="keyword">const</span> server=http.<span class="title function_">createServer</span>()<span class="comment">//web服务器实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//为服务器实例绑定request事件 监听客户端发送过来的网络请求</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="comment">//只要有客户端请求服务器，就会触发request事件，调用这个事件处理函数</span></span><br><span class="line">	<span class="keyword">const</span> str=<span class="string">`req url is <span class="subst">$&#123;req.url&#125;</span>,req method is <span class="subst">$&#123;req.method&#125;</span>`</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;welcome&#x27;</span>,str)</span><br><span class="line"></span><br><span class="line"><span class="comment">//防止中文乱码</span></span><br><span class="line">	res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;text/html;charset=utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//res.end()向客户端发送内容，并结束这次请求处理过程</span></span><br><span class="line">	res.<span class="title function_">end</span>(str)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据不同url相应不同html内容</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="comment">//只要有客户端请求服务器，就会触发request事件，调用这个事件处理函数</span></span><br><span class="line">	<span class="keyword">const</span> url=req.<span class="property">url</span></span><br><span class="line">	<span class="keyword">let</span> content=<span class="string">&#x27;&lt;h1&gt;404 not found&lt;/h1&gt;&#x27;</span></span><br><span class="line">	<span class="keyword">if</span>(url===<span class="string">&#x27;/&#x27;</span> || url===<span class="string">&#x27;/index.html&#x27;</span>)&#123;</span><br><span class="line">		content=<span class="string">&#x27;&lt;h1&gt;welcome欢迎&lt;/h1&gt;&#x27;</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(url===<span class="string">&#x27;/about.html&#x27;</span>)&#123;</span><br><span class="line">		content=<span class="string">&#x27;&lt;h1&gt;it\&#x27;s me这是我 &lt;/h1&gt;&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//防止中文乱码</span></span><br><span class="line">	res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;text/html;charset=utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//res.end()向客户端发送内容，并结束这次请求处理过程</span></span><br><span class="line">	res.<span class="title function_">end</span>(content)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动服务器</span></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">80</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;running&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/04780934d734495b92a290f8ed0f17c7.png" alt="在这里插入图片描述"></p>
<h1 id="Express-框架"><a href="#Express-框架" class="headerlink" title="Express 框架"></a>Express 框架</h1><p>Web 开发框架。第三方包，提供快速创建 Web 服务器便捷方法。<a target="_blank" rel="noopener" href="http://www.expressjs.com.cn/">点击进入官网</a></p>
<ul>
<li>有http内置模块，为什么还要有express<br>http 内置模块用起来复杂，开发效率低；Express 是基于内置http 模块的封装。</li>
<li>express功能<br> Web 网站服务器：专门对外提供 Web 网页资源的服务器。<br>API 接口服务器：专门对外提供 API 接口的服务器。</li>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express#项目目录下</span><br></pre></td></tr></table></figure>
<ul>
<li>总结</li>
</ul>
<table>
<thead>
<tr>
<th>主题</th>
<th>常用 API &#x2F; 技能点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>安装与创建服务</strong></td>
<td><code>express()</code>、<code>app.listen()</code></td>
</tr>
<tr>
<td><strong>路由处理</strong></td>
<td><code>app.get()</code>、<code>app.post()</code>、路由参数 <code>:id</code></td>
</tr>
<tr>
<td><strong>中间件机制</strong></td>
<td><code>app.use()</code>、使用 <code>express.json()</code>、自定义中间件</td>
</tr>
<tr>
<td><strong>错误处理中间件</strong></td>
<td><code>(err, req, res, next)</code></td>
</tr>
<tr>
<td><strong>静态资源</strong></td>
<td><code>express.static()</code></td>
</tr>
</tbody></table>
<h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><table>
<thead>
<tr>
<th>对象</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>req.params</code></td>
<td>路径参数 <code>/user/:id</code></td>
</tr>
<tr>
<td><code>req.query</code></td>
<td>查询参数 <code>/search?q=xxx</code></td>
</tr>
<tr>
<td><code>req.body</code></td>
<td>POST 请求体（需中间件解析）</td>
</tr>
<tr>
<td><code>res.send()</code></td>
<td>发送文本或 JSON</td>
</tr>
<tr>
<td><code>res.json()</code></td>
<td>显式发送 JSON</td>
</tr>
</tbody></table>
<ul>
<li>获取 URL 中携带的查询参数<br>res.query默认是空对象，通过 req.query 对象，可以访问到客户端通过查询字符串的形式，发送到服务器的参数，如?name&#x3D;zs&amp;age&#x3D;20</li>
<li>获取URL动态参数<br>通过<code>:</code>匹配到的动态参数可通过 req.params 对象访问到。<br>req.params 默认是空对象<br><code>router.get(&#39;/cates/:id&#39;, artcate_handler.getArticleById);</code>，<code>:id</code> 是动态参数，Express 会解析，<br><code>const id = req.params.id; // 获取 URL 中的 id</code></li>
<li>get post函数<br><code>router.post(path, [middleware1, middleware2, ...,] handler)</code>get同理<br>多个中间件会按顺序依次执行<br>最后一个是 路由处理函数（handler）<br>真正处理业务逻辑的函数，通常是控制器里的方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app=<span class="title function_">express</span>()<span class="comment">//创建web服务器</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>,<span class="function">()=&gt;</span>&#123;<span class="comment">//端口号 启动服务器</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;welcome&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;url&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;<span class="comment">//监听客户端GET请求</span></span><br><span class="line"><span class="comment">//req请求</span></span><br><span class="line"><span class="comment">//res响应</span></span><br><span class="line">	res.<span class="title function_">send</span>(&#123;<span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>,<span class="attr">age</span>:<span class="number">20</span>&#125;)<span class="comment">//发送给客户端JSON对象</span></span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;url&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;<span class="comment">//监听客户端POST请求</span></span><br><span class="line"><span class="comment">//req请求</span></span><br><span class="line"><span class="comment">//res响应</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;请求成功&#x27;</span>)<span class="comment">//发送给客户端文本</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 注意：这里的 :id 是一个动态的参数</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user/:ids/:username&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// req.params 是动态匹配到的 URL 参数，默认也是一个空对象</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">params</span>)</span><br><span class="line">  res.<span class="title function_">send</span>(req.<span class="property">params</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/info&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;<span class="comment">//返回json格式</span></span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="托管静态资源"><a href="#托管静态资源" class="headerlink" title="托管静态资源"></a>托管静态资源</h2><ul>
<li>express.static() 可以方便地创建静态资源服务器，例如，将 public 目录下图片、CSS 文件、JavaScript 文件对外开放访问：<br>注意：Express 在指定静态目录中查找文件，并对外提供资源访问路径。存放静态文件的目录名不会出现在 URL 中。如<a target="_blank" rel="noopener" href="http://localhost:3000/images/bg.jpg">http://localhost:3000/images/bg.jpg</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/css/style.css">http://localhost:3000/css/style.css</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/js/login.js">http://localhost:3000/js/login.js</a></li>
<li>挂载路径前缀<br>挂载某个路径则可以在这个前缀地址下访问对应目录中的文件，如：通过带有 &#x2F;public 前缀地址来访问 public 目录中的文件<br><a target="_blank" rel="noopener" href="http://localhost:3000/public/images/kitten.jpg">http://localhost:3000/public/images/kitten.jpg</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/public/css/style.css">http://localhost:3000/public/css/style.css</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/public/js/app.js">http://localhost:3000/public/js/app.js</a></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;./public&#x27;</span>))<span class="comment">//开放访问 public 目录中的所有文件</span></span><br><span class="line"><span class="comment">//多次调用则托管多个静态资源目录</span></span><br><span class="line"><span class="comment">//访问静态资源文件时，express.static() 函数会根据目录的添加顺序查找所需的文件。</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/public&#x27;</span>,express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>))<span class="comment">//挂载路径前缀</span></span><br></pre></td></tr></table></figure>
<h2 id="nodemon"><a href="#nodemon" class="headerlink" title="nodemon"></a>nodemon</h2><p>作用：热加载（<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/nodemon%EF%BC%89">https://www.npmjs.com/package/nodemon）</a> 能够监听项目文件变动，当代码被修改后，nodemon 自动重启项目，<br>将 node 命令替换为 nodemon 命令，使用 nodemon app.js 来启动项目。好处是：代码修改后，会被 nodemon 监听到，自动重启项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i -g nodemon <span class="comment">#安装</span></span><br><span class="line">nodemon app.js <span class="comment">#使用</span></span><br></pre></td></tr></table></figure>
<h2 id="路由（映射关系）"><a href="#路由（映射关系）" class="headerlink" title="路由（映射关系）"></a>路由（映射关系）</h2><p>在 Express 中，路由指客户端请求与服务器处理函数之间的映射关系。Express 路由分 3 部分组成，分别是请求类型、请求 URL 地址、处理函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">METHOD</span>(<span class="variable constant_">PATH</span>,<span class="variable constant_">HANDLER</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;<span class="comment">//挂载路由</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入路由模块</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;./apiRouter&#x27;</span>)</span><br><span class="line"><span class="comment">// 把路由模块，注册到 app 上</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, router)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//apiRouter.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里挂载对应的路由</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/get&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 通过 req.query 获取客户端通过查询字符串，发送到服务器的数据</span></span><br><span class="line">  <span class="keyword">const</span> query = req.<span class="property">query</span></span><br><span class="line">  <span class="comment">// 调用 res.send() 方法，向客户端响应处理的结果</span></span><br><span class="line">  res.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="number">0</span>, <span class="comment">// 0 表示处理成功，1 表示处理失败</span></span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;GET 请求成功！&#x27;</span>, <span class="comment">// 状态的描述</span></span><br><span class="line">    <span class="attr">data</span>: query, <span class="comment">// 需要响应给客户端的数据</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 POST 接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/post&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 通过 req.body 获取请求体中包含的 url-encoded 格式的数据</span></span><br><span class="line">  <span class="keyword">const</span> body = req.<span class="property">body</span></span><br><span class="line">  <span class="comment">// 调用 res.send() 方法，向客户端响应结果</span></span><br><span class="line">  res.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;POST 请求成功！&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: body,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 DELETE 接口</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/delete&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;DELETE请求成功&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>
<ul>
<li>路由匹配过程<br>路由匹配的注意点：<br>按照定义的先后顺序进行匹配<br>请求类型和请求的URL同时匹配成功，才会调用对应的处理函数<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/144926badfbd4978b93b0b34965581a7.png" alt="在这里插入图片描述"></li>
<li>模块化路由<br>将路由抽离为单独模块的步骤：<br>创建路由模块对应的 .js 文件<br>调用 express.Router() 函数创建路由对象<br>向路由对象上挂载具体的路由<br>使用 module.exports 向外共享路由对象<br>使用 app.use() 函数注册路由模块</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//user.js</span></span><br><span class="line"><span class="keyword">var</span> express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> router=express.<span class="title class_">Router</span>() <span class="comment">//创建路由对象</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/user/list&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123; <span class="comment">//挂载具体路由</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/user/add&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;add user&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=router <span class="comment">//导出路由对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter=<span class="built_in">require</span>(<span class="string">&#x27;./router/user.js&#x27;</span>) <span class="comment">//导入</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter) <span class="comment">//使用app.use注册路由模块</span></span><br><span class="line"><span class="comment">//不设置路径前缀，则所有 userRouter 中定义的路由路径都是直接作为全路径使用的。</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>,userRouter)<span class="comment">//挂载前缀，为路由模块添加前缀</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;<span class="comment">//最后都要指定端口号并启动web服务器</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>中间件（Middleware ）：业务流程的中间处理环节。<br>全局生效的中间件：客户端发起的任何请求，到达服务器之后，都会触发的中间件，叫做全局生效的中间件。通过调用 app.use(中间件函数)，即可定义一个全局生效的中间件。</p>
<ul>
<li>中间件的调用流程<br>当一个请求到达 Express 服务器后，可以连续调用多个中间件，对这次请求进行预处理。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/ab373aebb8944400af6f16e76273f3d0.png" alt="在这里插入图片描述"></li>
<li>本质<br>Express 中间件，本质是function 处理函数。注意：中间件函数形参列表中必须包含 next 参数。而路由处理函数中只包含 req 和 res。<br>Express 中间件的格式如下：<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/9dfaae364ab846239551062aa32a0b0b.png" alt="在这里插入图片描述"><br>多个中间件之间，共享同一份 req 和 res。可以在上游中间件中，统一为 req 或 res 对象添加自定义的属性或方法，供下游的中间件或路由进行使用。<br>app.use() 可连续定义多个全局中间件。客户端请求到达服务器后，按照中间件<strong>定义先后顺序</strong>依次调用。</li>
<li>next函数作用：实现多个中间件连续调用关键，表示把流转关系转交给下个中间件&#x2F;路由。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/93af6101197f4a8f89900e523bdbaccd.png" alt="在这里插入图片描述"></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());            <span class="comment">// 解析 JSON 请求体</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;)); <span class="comment">// 解析表单</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义中间件函数</span></span><br><span class="line"><span class="keyword">const</span> mw=<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;mw&#x27;</span>)</span><br><span class="line">	<span class="title function_">next</span>()<span class="comment">//当前中间件任务处理完后next交给下一中间件或路由</span></span><br><span class="line">&#125;</span><br><span class="line">app.<span class="title function_">use</span>(mw)<span class="comment">//全局生效中间件</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;<span class="comment">//简化形式</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;mw&#x27;</span>)</span><br><span class="line">	<span class="title function_">next</span>()<span class="comment">//当前中间件任务处理完后next交给下一中间件或路由</span></span><br><span class="line">&#125;)<span class="comment">//全局生效中间件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//多个全局中间件 按定义先后顺序调用</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;first mw&#x27;</span>)</span><br><span class="line">	<span class="title function_">next</span>()<span class="comment">//当前中间件任务处理完后next交给下一中间件或路由</span></span><br><span class="line">&#125;)<span class="comment">//全局生效中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;second mw&#x27;</span>)</span><br><span class="line">	<span class="title function_">next</span>()<span class="comment">//当前中间件任务处理完后next交给下一中间件或路由</span></span><br><span class="line">&#125;)<span class="comment">//全局生效中间件</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;<span class="comment">//请求这个路由，先依次触发上述两个全局中间件</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;user page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//局部中间件</span></span><br><span class="line"><span class="comment">//不使用 app.use() 定义的中间件，叫做局部生效中间件。</span></span><br><span class="line"><span class="keyword">const</span> mw1=<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;mw&#x27;</span>)</span><br><span class="line">	<span class="title function_">next</span>()<span class="comment">//当前中间件任务处理完后next交给下一中间件或路由</span></span><br><span class="line">&#125;</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>,mw1,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;<span class="comment">//中间件mw1只在当前路由中生效</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;user page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/a&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;<span class="comment">//中间件mw1不会影响这个路由</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;a  page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//多个局部中间件</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>,mw1,mw2,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;user page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>,[mw1,mw2],<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;user page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> &#123;<span class="comment">//最后都要加上监听 指定端口并启动web服务器</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//例子</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是定义全局中间件的简化形式：箭头函数</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取到请求到达服务器的时间</span></span><br><span class="line">  <span class="keyword">const</span> time = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="comment">// 为 req 对象，挂载自定义属性，从而把时间共享给后面的所有路由</span></span><br><span class="line">  req.<span class="property">startTime</span> = time</span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//异常中间件统一捕获</span></span><br><span class="line"><span class="comment">// 主逻辑中抛出错误</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/fail&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Something broke!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误处理中间件（最后一个）</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">code</span>: -<span class="number">1</span>,</span><br><span class="line">    <span class="attr">msg</span>: err.<span class="property">message</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>注意<br>一定要在<strong>路由之前</strong>注册中间件<br>执行完中间件的业务代码之后，不要忘记调用 next() 函数<br>为防止代码逻辑混乱，调用 next() 函数后不要再写额外的代码<br>连续调用多个中间件时，多个中间件之间，<strong>共享 req 和 res 对象</strong></li>
<li>中间件分类 5类<br> 应用级别<br>路由级别<br>错误级别<br>Express 内置<br>第三方</li>
<li>应用级别的中间件<br> app.use() 或 app.get() 或 app.post() 绑定到 app 实例上的中间件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123; <span class="comment">//全局中间件</span></span><br><span class="line">	<span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,mw1,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123; <span class="comment">//局部中间件</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;index page&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>路由级别中间件<br>绑定到 express.Router() 实例上的中间件<br>用法和应用级别中间件没有任何区别。只不过应用级别中间件绑定到 app 实例上，路由级别中间件绑定到 router 实例上</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app=<span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">var</span> router=express.<span class="title class_">Router</span>()</span><br><span class="line">router.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>())</span><br><span class="line">	<span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/&#x27;</span>,router)</span><br></pre></td></tr></table></figure>
<ul>
<li>错误级别的中间件<br>专门用来捕获整个项目中异常错误，从而防止项目异常崩溃问题。<br>注意：错误级别的中间件必须注册在所有路由之后！<br>格式：错误级别中间件 function 处理函数中，必须有 4 个形参，形参顺序从前到后，分别是 (err, req, res, next)。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123; <span class="comment">//路由</span></span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error msg&#x27;</span>)<span class="comment">//抛出错误</span></span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;index page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">err,req,res,next</span>)&#123; <span class="comment">//错误级别中间件</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	res.<span class="title function_">send</span>(err.<span class="property">message</span>)<span class="comment">//返回给客户端错误信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>Express内置中间件<br> express.static 快速托管静态资源的内置中间件，例如： HTML 文件&#x2F;图片&#x2F;CSS 样式等（无兼容性）<br>express.json 解析 JSON 格式的请求体数据（兼容性，仅在 4.16.0+ 版本中可用）<br>express.urlencoded 解析 URL-encoded 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>())</span><br><span class="line"><span class="comment">//配置中间件解析application/json格式数据 放入res.body</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>:<span class="literal">false</span>&#125;))</span><br><span class="line"><span class="comment">//配置解析application/x-www-form-urlencoded格式数据的内置中间件</span></span><br><span class="line"><span class="comment">//放入res.body</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在服务器，可以使用 req.body 这个属性，来接收客户端发送过来的请求体数据</span></span><br><span class="line">  <span class="comment">// 默认情况下，如果不配置解析表单数据的中间件，则 req.body 默认等于 undefined</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/book&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在服务器端，可通过 req.body 获取 JSON 格式的表单数据和 url-encoded 格式的数据</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>第三方的中间件<br>按需下载并配置第三方中间件。<br>例如：在 <a href="mailto:&#101;&#x78;&#x70;&#114;&#x65;&#x73;&#115;&#x40;&#52;&#46;&#x31;&#54;&#46;&#x30;">express@4.16.0</a> 之前的版本中，经常使用 body-parser 这个第三方中间件解析请求体数据。使用步骤如下：<br>运行 npm install body-parser 安装中间件<br>使用 require 导入中间件<br>调用 app.use() 注册并使用中间件<br>注意：Express 内置 express.urlencoded 中间件，就是基于 body-parser 第三方中间件封装的。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 express 模块</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// 创建 express 的服务器实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 导入解析表单数据的中间件 body-parser</span></span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// 2. 使用 app.use() 注册中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(parser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// app.use(express.urlencoded(&#123; extended: false &#125;))</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果没有配置任何解析表单数据的中间件，则 req.body 默认等于 undefined</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>)</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Express server running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义中间件<br>手动模拟类似 express.urlencoded 中间件，解析 POST 提交到服务器的表单数据。<br>实现步骤：<br>定义中间件<br>监听 req 的 data 事件，获取客户端发送到服务器的数据。如果数据量比较大，无法一次性发送完毕，则客户端会把数据切割后，分批发送到服务器。所以 data 事件可能触发多次，需要手动对接收数据拼接。<br>监听 req 的 end 事件：请求体数据接收完毕后，自动触发 req 的 end 事件。可以在 req 的 end 事件中，拿到并处理完整请求体数据。</li>
<li>使用 querystring 模块解析请求体数据<br>Node.js 内置 querystring 模块，专门用来处理查询字符串。通过这个模块parse() 函数，把查询字符串解析成对象格式。</li>
<li>将解析出来的数据对象挂载为 req.body<br>上游的中间件和下游的中间件及路由之间，共享同一份 req 和 res。可以将解析出来的数据，挂载为 req 的自定义属性，命名为 req.body，供下游使用。</li>
<li>将自定义中间件封装为模块</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 express 模块</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// 创建 express 的服务器实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="comment">// 导入 Node.js 内置的 querystring 模块</span></span><br><span class="line"><span class="keyword">const</span> qs = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是解析表单数据中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 定义中间件具体的业务逻辑</span></span><br><span class="line">  <span class="comment">// 1. 定义str 字符串专门存储客户端发送过来的请求体数据</span></span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="comment">// 2. 监听 req 的 data 事件</span></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    str += chunk</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 3. 监听 req 的 end 事件</span></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在 str 中存放完整的请求体数据</span></span><br><span class="line">    <span class="comment">// console.log(str)</span></span><br><span class="line">    <span class="comment">//  把字符串格式的请求体数据，解析成对象格式</span></span><br><span class="line">    <span class="keyword">const</span> body = qs.<span class="title function_">parse</span>(str)</span><br><span class="line">    req.<span class="property">body</span> = body</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(req.<span class="property">body</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Express server running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//封装为模块 custom-body-parser.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = bodyParser</span><br><span class="line"></span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="comment">// 导入 express 模块</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// 创建 express 的服务器实例</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 导入自己封装的中间件模块</span></span><br><span class="line"><span class="keyword">const</span> customBodyParser = <span class="built_in">require</span>(<span class="string">&#x27;./custom-body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// 2. 将自定义的中间件函数，注册为全局可用的中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(customBodyParser)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(req.<span class="property">body</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Express server running at http://127.0.0.1&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>REST API<br>使用 mysql2、sequelize 或 mongoose 操作数据库<br>封装数据库连接池<br>用户增删改查接口<br>接入 Swagger 文档<br>🧪 项目：写一个用户管理接口 API</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>常用操作</th>
</tr>
</thead>
<tbody><tr>
<td><strong>MongoDB + Mongoose</strong></td>
<td>连接数据库、定义 Schema、增删改查</td>
</tr>
<tr>
<td><strong>MySQL + Sequelize</strong></td>
<td>连接数据库、建表模型、增删改查、分页查询</td>
</tr>
</tbody></table>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>SQL（英文全称：Structured Query Language）是结构化查询语言，只能在关系型数据库中使用（例如 MySQL、Oracle、SQL Server）。非关系型数据库（例如 Mongodb）不支持 SQL 语言</p>
<ul>
<li>传统数据库：分为数据库(database)、数据表(table)、数据行(row)、字段(field)这 4 大部分组。字段相当于列。</li>
<li>mysql安装配置<br>只需要安装 MySQL Server 和 MySQL Workbench<br>MySQL Server：专门用来提供数据存储和服务的软件。<br>MySQL Workbench：可视化 MySQL 管理工具</li>
<li>Mac 环境下安装 MySQL 的过程<br>先运行 mysql-8.0.19-macos10.15-x86_64.dmg 这个安装包，将 MySQL Server 安装到 Mac 系统<br>再运行 mysql-workbench-community-8.0.19-macos-x86_64.dmg 这个安装包，将可视化的 MySQL Workbench 工具安装到 Mac 系统</li>
<li>Windows 环境下安装 MySQL，只需要运行 mysql-installer-community-8.0.19.0.msi 这个安装包，一次性将 MySQL Server  和 MySQL Workbench 安装到自己的电脑上。</li>
<li>MySQL Workbench 管理数据库<br>DataType 数据类型：<br> int 整数<br> varchar(len) 字符串<br> tinyint(1) 布尔值<br>字段的特殊标识：<br> PK（Primary Key）主键、唯一标识<br> NN（Not Null）值不允许为空<br> UQ（Unique）值唯一<br> AI（Auto Increment）值自动增长</li>
<li>数据库与express项目整合<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/22d236b77e744c21a7564cc7480d088d.png" alt="在这里插入图片描述"></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 模块是托管于 npm 上的第三方模块。</span></span><br><span class="line"><span class="comment">#提供了在 Node.js 项目中连接和操作 MySQL 数据库的能力。</span></span><br><span class="line">npm install mysql</span><br></pre></td></tr></table></figure>
<ul>
<li>配置 mysql 模块<br>使用 mysql 模块操作 MySQL 数据库之前，必须先对 mysql 模块配置，步骤如下：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql=<span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> db=mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">	<span class="attr">host</span>:<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">	<span class="attr">user</span>:<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">	<span class="attr">password</span>:<span class="string">&#x27;admin123&#x27;</span>,</span><br><span class="line">	<span class="attr">database</span>:<span class="string">&#x27;my_db_1&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//测试能否正常工作</span></span><br><span class="line">db.<span class="title function_">query</span>(<span class="string">&#x27;select 1&#x27;</span>,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(res)<span class="comment">//[RowDataPacket &#123;&#x27;1&#x27;:1&#125;]</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> new_user=&#123;<span class="attr">username</span>:<span class="string">&#x27;zs&#x27;</span>,<span class="attr">password</span>:<span class="string">&#x27;123456&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">const</span> sqlStr=<span class="string">&#x27;insert into users (username,password) values (?,?)&#x27;</span></span><br><span class="line"><span class="comment">//?表示占位符</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr,[new_user.<span class="property">username</span>,new_user.<span class="property">password</span>],<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(res)<span class="comment">//[RowDataPacket &#123;&#x27;1&#x27;:1&#125;]</span></span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//select的结果不用res.affectedRows而是res.length</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//快速插入数据</span></span><br><span class="line"><span class="comment">//适用于数据对象每个属性都能和数据库字段一一对应的情况</span></span><br><span class="line"><span class="keyword">const</span> simple_sqlstr=<span class="string">&#x27;insert into users set ?&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(simple_sqlstr,new_user,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(res)<span class="comment">//[RowDataPacket &#123;&#x27;1&#x27;:1&#125;]</span></span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新</span></span><br><span class="line"><span class="keyword">const</span> u=&#123;<span class="attr">id</span>:<span class="number">7</span>,<span class="attr">username</span>:<span class="string">&#x27;a&#x27;</span>,<span class="attr">password</span>:<span class="string">&#x27;new123&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">const</span> sqlStr=<span class="string">&#x27;update users set username=?,password=? where id=?&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr,[user.<span class="property">username</span>,user.<span class="property">password</span>,user.<span class="property">id</span>],<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//全属性字段一一对应的更新也可以简化</span></span><br><span class="line"><span class="keyword">const</span> u=&#123;<span class="attr">id</span>:<span class="number">7</span>,<span class="attr">username</span>:<span class="string">&#x27;a&#x27;</span>,<span class="attr">password</span>:<span class="string">&#x27;new123&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">const</span> sqlStr=<span class="string">&#x27;update users set ? where id=?&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr,[user,user.<span class="property">id</span>],<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line"><span class="keyword">const</span> sqlStr=<span class="string">&#x27;delete from users where id=?&#x27;</span></span><br><span class="line">db.<span class="title function_">query</span>(sqlStr,<span class="number">7</span>,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//标记删除 设置类似于 status状态字段，标记当前这条数据是否被删除。</span></span><br><span class="line">db.<span class="title function_">query</span>(<span class="string">&#x27;update users set status=1 where id=?&#x27;</span>,<span class="number">6</span>,<span class="function">(<span class="params">err,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err)<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">	<span class="keyword">if</span>(res.<span class="property">affectedRows</span>===<span class="number">1</span>)<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Mongodb"><a href="#Mongodb" class="headerlink" title="Mongodb"></a>Mongodb</h2><p>Mongodb 非关系型数据库 或 NoSQL 数据库<br>mongoose 是MongoDB 的 ODM (Object Data Modeling) 库，它在 Node.js 应用和 MongoDB 之间提供更高级别抽象，可以用 JavaScript 对象方式操作 MongoDB 数据，而不是直接使用底层MongoDB 驱动。</p>
<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm install express mongoose</span><br><span class="line"><span class="comment"># 项目结构</span></span><br><span class="line">project/</span><br><span class="line">├── app.js</span><br><span class="line">├── models/</span><br><span class="line">│   └── user.js</span><br></pre></td></tr></table></figure>
<ul>
<li>使用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接mongodb</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">mongoose.<span class="title function_">connect</span>(<span class="string">&#x27;mongodb://localhost:27017/demo&#x27;</span>, &#123;<span class="comment">//mongodb://: 这是协议头</span></span><br><span class="line"><span class="comment">//demo:数据库名称。</span></span><br><span class="line">  <span class="attr">useNewUrlParser</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">useUnifiedTopology</span>: <span class="literal">true</span><span class="comment">//使用新的服务器发现和监控引擎</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;MongoDB connected&#x27;</span>));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义模型（User 模型）</span></span><br><span class="line"><span class="comment">// models/user.js</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userSchema = <span class="keyword">new</span> mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="title class_">Number</span>,</span><br><span class="line">  <span class="attr">email</span>: <span class="title class_">String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>, userSchema);</span><br><span class="line"><span class="comment">//数据将存储在 MongoDB 中名为 users集合里。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//CRUD</span></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;./models/user&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  创建用户</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(req.<span class="property">body</span>);</span><br><span class="line">  <span class="keyword">await</span> user.<span class="title function_">save</span>();<span class="comment">//新增</span></span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">code</span>: <span class="number">0</span>, <span class="attr">data</span>: user &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  获取所有用户</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">find</span>();</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">code</span>: <span class="number">0</span>, <span class="attr">data</span>: users &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  获取单个用户</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/users/:id&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">code</span>: <span class="number">0</span>, <span class="attr">data</span>: user &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  更新用户</span></span><br><span class="line">app.<span class="title function_">put</span>(<span class="string">&#x27;/users/:id&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndUpdate</span>(req.<span class="property">params</span>.<span class="property">id</span>, req.<span class="property">body</span>, &#123; <span class="attr">new</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">code</span>: <span class="number">0</span>, <span class="attr">data</span>: user &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  删除用户</span></span><br><span class="line">app.<span class="title function_">delete</span>(<span class="string">&#x27;/users/:id&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndDelete</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">code</span>: <span class="number">0</span>, <span class="attr">msg</span>: <span class="string">&#x27;Deleted&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//统一返回结构</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//常见方法</span></span><br><span class="line"><span class="comment">// 查</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">find</span>();                     <span class="comment">// 查所有</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">findById</span>(id);              <span class="comment">// 按 ID 查</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">username</span>: <span class="string">&#x27;a&#x27;</span> &#125;); <span class="comment">// 查一个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 增</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(data);</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">save</span>();              <span class="comment">// 保存方式 1</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(data);        <span class="comment">// 保存方式 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 改</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndUpdate</span>(id, newData, &#123; <span class="attr">new</span>: <span class="literal">true</span> &#125;); <span class="comment">// 返回更新后的数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findByIdAndDelete</span>(id);</span><br></pre></td></tr></table></figure>
<h1 id="编写接口"><a href="#编写接口" class="headerlink" title="编写接口"></a>编写接口</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建服务器 index.js</span></span><br><span class="line"><span class="keyword">const</span> express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app=<span class="title function_">express</span>()</span><br><span class="line"><span class="comment">/*TODO*/</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> api_router=<span class="built_in">require</span>(<span class="string">&#x27;./api_router.js&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>,api_router)</span><br><span class="line">api_router.<span class="title function_">get</span>(<span class="string">&#x27;/get&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> query=req.<span class="property">query</span></span><br><span class="line">	res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="attr">status</span>:<span class="number">0</span>,</span><br><span class="line">		<span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">		<span class="attr">data</span>:query</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">api_router.<span class="title function_">post</span>(<span class="string">&#x27;/post&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> body=req.<span class="property">body</span></span><br><span class="line">	res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="attr">status</span>:<span class="number">0</span>,</span><br><span class="line">		<span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">		<span class="attr">data</span>:body</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//如果要获取 URL-encoded 格式的请求体数据，</span></span><br><span class="line"><span class="comment">//必须配置中间件 app.use(express.urlencoded(&#123; extended: false &#125;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建api路由模块 api_router.js</span></span><br><span class="line"><span class="keyword">const</span> express=<span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> api_router=express.<span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">/*TODO*/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=api_router</span><br></pre></td></tr></table></figure>
<h2 id="CORS-跨域资源共享"><a href="#CORS-跨域资源共享" class="headerlink" title="CORS 跨域资源共享"></a>CORS 跨域资源共享</h2><p>CORS （Cross-Origin Resource Sharing，跨域资源共享） HTTP 响应头决定浏览器是否阻止前端 JS 代码跨域获取资源。<br>浏览器的同源安全策略默认阻止网页“跨域”获取资源。但如果接口服务器配置 CORS 相关 HTTP 响应头，就可以解除浏览器端的跨域访问限制。<br>CORS 主要在服务器端进行配置。客户端浏览器无须做任何额外的配置。<br>CORS 有兼容性：只支持 XMLHttpRequest Level2 浏览器，才能正常访问开启 CORS 的服务端接口（例如：IE10+、Chrome4+、FireFox3.5+）。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/24d17f6acead46f4829283f7fc459fb4.png" alt="在这里插入图片描述"></p>
<ul>
<li>CORS响应头部设置</li>
</ul>
<ol>
<li>CORS 响应头部 - Access-Control-Allow-Origin</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//响应头部中可以携带一个 Access-Control-Allow-Origin 字段</span></span><br><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Origin</span>:&lt;origin&gt; | *</span><br><span class="line"><span class="comment">//origin指定允许访问该资源的外域url</span></span><br><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>,<span class="string">&#x27;apple.cn&#x27;</span>)</span><br><span class="line"><span class="comment">//只允许来自apple.cn的请求</span></span><br><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>,<span class="string">&#x27;*&#x27;</span>)<span class="comment">//全部允许</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>CORS 响应头部 - Access-Control-Allow-Headers<br>默认CORS 仅支持客户端向服务器发送如下 9 个请求头：<br>Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type （值仅限于 text&#x2F;plain、multipart&#x2F;form-data、application&#x2F;x-www-form-urlencoded 三者之一）<br>如果客户端向服务器发送额外的请求头信息，则需要在服务器端，通过 Access-Control-Allow-Headers 对额外的请求头声明，否则请求失败！</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//允许客户端向服务端发送Content-Type+X-Custom-Header请求头</span></span><br><span class="line"><span class="comment">//,分割</span></span><br><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span>,<span class="string">&#x27;Content-Type,X-Custom-Header&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>CORS 响应头部 - Access-Control-Allow-Methods<br>默认CORS 仅支持客户端发起 GET、POST、HEAD 请求。<br>如果客户端通过 PUT、DELETE 等方式请求服务器资源，则需要在服务器端通过 Access-Control-Alow-Methods指明实际请求允许使用的 HTTP 方法。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>,<span class="string">&#x27;GET,HEAD&#x27;</span>)</span><br><span class="line">res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>,<span class="string">&#x27;*&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>HEAD 请求方法<br>是 HTTP 协议中一种请求方法，和 GET 方法类似，但它只请求响应头部信息，不返回消息体（body）。服务器会像处理 GET 请求一样处理 HEAD 请求，但最后只返回响应头，不包括实际内容数据。<br>它有什么用？<br>1）测试资源是否存在：比如你想知道某个网页、图片、文件是否存在，但不想下载整个内容，就可以发一个 HEAD 请求。<br>2）查看资源的元信息：比如查看：<br>内容类型（Content-Type）<br>内容长度（Content-Length）<br>最后修改时间（Last-Modified）<br>缓存相关头部（Cache-Control，ETag 等）<br>3）节省带宽：因为不下载内容，所以比 GET 请求节省网络资源。<br>4）用于断点续传或更新判断<br>比如查看服务器上文件是否更新（通过 ETag 或 Last-Modified），再决定是否重新下载。</p>
</blockquote>
<ul>
<li>CORS请求的分类分为两大类，分别是：简单请求、预检请求<ul>
<li>简单请求和预检请求的区别<br>  简单请求的特点：客户端与服务器之间只会发生一次请求。<br>  预检请求的特点：客户端与服务器之间会发生两次请求，OPTION 预检请求成功后，才发起真正的请求。</li>
<li>简单请求<br>  同时满足以下两大条件的请求，就属于简单请求：<br>   请求方式：GET、POST、HEAD 三者之一<br>   HTTP 头部信息不超过以下几种字段：无自定义头部字段、Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type（只有三个值application&#x2F;x-www-form-urlencoded、multipart&#x2F;form-data、text&#x2F;plain）</li>
<li>预检请求<br>在浏览器与服务器正式通信之前，浏览器会先发送 OPTION 请求预检，获知服务器是否允许该实际请求。服务器成功响应预检请求后，才会发送真正请求并且携带真实数据。</li>
</ul>
</li>
<li>使用 cors 中间件解决跨域问题<br>cors 是 Express 第三方中间件。安装和配置 cors 中间件，解决跨域问题。<br>使用步骤分为如下 3 步：<br>运行 npm install cors 安装中间件<br>使用 const cors &#x3D; require(‘cors’) 导入中间件<br>在路由之前调用 app.use(cors()) 配置中间件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//限制允许来源</span></span><br><span class="line"><span class="keyword">const</span> corsOptions = &#123;</span><br><span class="line">  <span class="attr">origin</span>: [<span class="string">&#x27;http://example.com&#x27;</span>, <span class="string">&#x27;http://localhost:3000&#x27;</span>],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//设置其他cors选项</span></span><br><span class="line"><span class="keyword">const</span> corsOptions = &#123;</span><br><span class="line">  <span class="attr">origin</span>: <span class="string">&#x27;http://example.com&#x27;</span>,<span class="comment">//允许的地址</span></span><br><span class="line">  <span class="attr">methods</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>],<span class="comment">//允许的方法</span></span><br><span class="line">  <span class="attr">allowedHeaders</span>: [<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>],<span class="comment">//允许的请求头</span></span><br><span class="line">  <span class="attr">credentials</span>: <span class="literal">true</span>, <span class="comment">// 如果你需要允许携带 cookie</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>(corsOptions));</span><br><span class="line"></span><br><span class="line"><span class="comment">//为单独某个路由设置cors</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/special&#x27;</span>, <span class="title function_">cors</span>(&#123; <span class="attr">origin</span>: <span class="string">&#x27;http://specific-domain.com&#x27;</span> &#125;), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;This route has specific CORS settings&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//不用cors 手动设置</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="string">&#x27;https://example.com&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span>, <span class="string">&#x27;GET,POST,OPTIONS&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span>, <span class="string">&#x27;Content-Type&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对于预检请求（OPTIONS），直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">method</span> === <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">sendStatus</span>(<span class="number">200</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>JSONP 接口<br>浏览器端通过 &lt; script&gt; 标签的 src 属性，请求服务器上的数据，服务器返回函数调用。<br>实现 JSONP 接口步骤:<br>获取客户端发送过来的回调函数的名字<br>得到要通过 JSONP 形式发送给客户端的数据<br>根据前两步得到的数据，拼接出一个函数调用的字符串<br>把上一步拼接得到的字符串，响应给客户端的 &lt; script&gt; 标签进行解析执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务端</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/jsonp&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> funcName=req.<span class="property">query</span>.<span class="property">callback</span></span><br><span class="line">	<span class="keyword">const</span> return_data=&#123;<span class="attr">name</span>:<span class="string">&#x27;66&#x27;</span>&#125;</span><br><span class="line">	<span class="keyword">const</span> scriptStr=<span class="string">`<span class="subst">$&#123;funcName&#125;</span>($(JSON.stringify(data)))`</span></span><br><span class="line">	res.<span class="title function_">send</span>(scriptStr)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端</span></span><br><span class="line"><span class="comment">//在网页中使用 jQuery 发起 JSONP 请求</span></span><br><span class="line"><span class="comment">//调用 $.ajax() 函数，提供 JSONP 的配置选项，从而发起 JSONP 请求</span></span><br><span class="line">$(<span class="string">&#x27;btnJsonp&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">		<span class="attr">method</span>:<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">		<span class="attr">url</span>:<span class="string">&#x27;http://niub.cn/api/jsonp&#x27;</span>,</span><br><span class="line">		<span class="attr">dataType</span>:<span class="string">&#x27;jsonp&#x27;</span>,</span><br><span class="line">		<span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>特点：<br>JSONP 不属于真正的 Ajax 请求，因为它没有使用 XMLHttpRequest 对象。<br>JSONP 仅支持 GET 请求，不支持 POST、PUT、DELETE 等请求。<br>注意事项：如果项目已经配置 CORS 跨域资源共享，为防止冲突，必须在配置 CORS 中间件之前声明 JSONP 接口。否则 JSONP 接口会被处理成开启CORS 的接口。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//优先创建jsonp接口 则不会被处理成cors接口</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/jsonp&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>())<span class="comment">//后续的接口都会被处理成cors接口</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/get&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="前后端身份认证"><a href="#前后端身份认证" class="headerlink" title="前后端身份认证"></a>前后端身份认证</h1><ul>
<li>web开发模式<br>有两种，分别是：<br>基于服务端渲染的传统 Web 开发模式<br>基于前后端分离的新型 Web 开发模式<br>如何选择？根据业务场景<br>比如企业级网站，主要功能是展示、没有复杂的交互、需要良好 SEO，使用服务器端渲染；<br>而类似后台管理项目，交互性比较强、不需要考虑 SEO，使用前后端分离<br>另外，为同时兼顾首页渲染速度和前后端分离的开发效率，一些网站采用首屏服务器端渲染 + 其他页面前后端分离的开发模式。</li>
<li>服务端渲染的 Web 开发模式<br>服务端渲染的概念：服务器发送给客户端的 HTML 页面，是在服务器通过字符串的拼接，动态生成的。因此，客户端不需要使用 Ajax 这样的技术额外请求页面的数据。<ul>
<li>优点：<br> 前端耗时少。因为服务器端负责动态生成 HTML 内容，浏览器只需要直接渲染页面即可。尤其是移动端，更省电。<br>有利于SEO。因为服务器端响应的是完整的 HTML 页面内容，所以爬虫更容易爬取获得信息，更有利于 SEO。</li>
<li>缺点：<br> 占用服务器端资源。即服务器端完成 HTML 页面内容的拼接，如果请求较多，会对服务器造成一定的访问压力。<br>不利于前后端分离，开发效率低。使用服务器端渲染，则无法进行分工合作，尤其对于前端复杂度高的项目，不利于项目高效开发。</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;index.html&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> user=&#123;<span class="attr">name</span>:<span class="string">&#x27;zs&#x27;</span>,<span class="attr">age</span>:<span class="number">20</span>&#125;</span><br><span class="line">	<span class="keyword">const</span> html=<span class="string">`&lt;h1&gt;name:<span class="subst">$&#123;user.name&#125;</span>,age:<span class="subst">$&#123;user.age&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">	res.<span class="title function_">send</span>(html)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>前后端分离的 Web 开发模式<br>前后端分离的概念：前后端分离的开发模式，依赖于 Ajax 技术的广泛应用。简而言之，前后端分离的 Web 开发模式，就是后端只负责提供 API 接口，前端使用 Ajax 调用接口的开发模式。<ul>
<li>优点：<br> 开发体验好。前端专注于 UI 页面的开发，后端专注于api 的开发，且前端有更多的选择性。<br>用户体验好。Ajax 技术的广泛应用，极大的提高了用户的体验，可以轻松实现页面的局部刷新。<br>减轻了服务器端的渲染压力。因为页面最终是在每个用户的浏览器中生成的。</li>
<li>缺点：<br> 不利于 SEO。因为完整的 HTML 页面需要在客户端动态拼接完成，所以爬虫对无法爬取页面的有效信息。（解决方案：利用 Vue、React 等前端框架的 SSR （server side render）技术能够很好的解决 SEO 问题！）</li>
</ul>
</li>
</ul>
<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><p>身份认证（Authentication）完成对用户身份的确认。<br>对于服务端渲染和前后端分离这两种开发模式来说，分别有着不同的身份认证方案：<br> 服务端渲染推荐使用 Session 认证机制<br> 前后端分离推荐使用 JWT 认证机制</p>
<h3 id="Session-认证机制-cookie"><a href="#Session-认证机制-cookie" class="headerlink" title="Session 认证机制+cookie"></a>Session 认证机制+cookie</h3><ul>
<li>HTTP 协议的无状态性<br>指的是客户端的每次 HTTP 请求都是独立的，连续多个请求之间没有直接的关系，服务器不会主动保留每次 HTTP 请求的状态。</li>
<li>如何突破 HTTP 无状态的限制：Cookie。<br>Cookie 是存储在用户浏览器中不超过 4 KB 的字符串。由一个名称（Name）、一个值（Value）和其它几个用于控制 Cookie 有效期、安全性、使用范围的可选属性组成。<br>不同域名下 Cookie 各自独立，每当客户端发起请求时，会自动把当前域名下所有未过期的 Cookie 一同发送到服务器。<ul>
<li>Cookie的几大特性：<br>自动发送<br>域名独立<br>过期时限<br>4KB 限制<br>不具有安全性</li>
</ul>
</li>
<li>Cookie 在身份认证中的作用<br>客户端第一次请求服务器，服务器通过响应头形式，向客户端发送身份认证 Cookie，客户端会自动将 Cookie 保存在浏览器中。<br>当客户端浏览器每次请求服务器时，浏览器自动将身份认证相关 Cookie，通过请求头形式发送给服务器，服务器即可验明客户端的身份。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/6e34197f29224b4a8abdba07b1a1a48c.png" alt="在这里插入图片描述"></li>
<li>Cookie v.s. Session<br>数据存储位置：浏览器 ； 服务器；<br>安全性：随机获取；加密存储；<br>数据类型：受浏览器限制；服务器存储，支持所有数据类型；<br>大小：默认4k；服务器空间大小；</li>
<li>提高身份认证的安全性：Session 认证机制<br>会话，用户登陆期间通信数据保存在session中，是服务端存储用户信息，不能随意访问，安全性较高，存储大小和数据类型由服务器决定。<br>session自动管理cookie：cookie数据需要服务器传递session_id过来，由服务器的session管理。</li>
<li>手动模拟客户端流程（类似于浏览器内部机制）<br>创建1个session实例<br>使用session实例，调用get，获取验证码 （无需获取cookie）<br>继续使用session实例，调用post，发送登陆请求（无需携带cookie）<br>继续使用session实例，调用get，发送获取我的订单请求（无需携带cookie）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python客户端 session模拟</span></span><br><span class="line"><span class="comment"># 类似于浏览器自动管理session</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#代码中全程见不到cookie的处理</span></span><br><span class="line">session =requests.Session()</span><br><span class="line">resp_v=session.get(url=<span class="string">&quot;verifycode_path&quot;</span>)</span><br><span class="line">resp_login=session.post(url=<span class="string">&quot;login_path&quot;</span>,data=&#123;</span><br><span class="line">	<span class="string">&quot;username&quot;</span>:username,</span><br><span class="line">	<span class="string">&quot;password&quot;</span>:password,</span><br><span class="line">	<span class="string">&quot;verify_code&quot;</span>:verifycode,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">print</span>(resp_login.json())</span><br><span class="line">resp_order=session.get(url=<span class="string">&quot;order_url&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(resp_order.json())</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">获取指定的响应数据</span></span><br><span class="line"><span class="string">resp.url</span></span><br><span class="line"><span class="string">resp.status_code</span></span><br><span class="line"><span class="string">resp.cookies</span></span><br><span class="line"><span class="string">resp.headers</span></span><br><span class="line"><span class="string">resp.text /json()</span></span><br><span class="line"><span class="string">注意：不是所有响应数据都能用json()转换过来！！</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>工作原理：<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/b7fde51cd01548d2a2533456fb137919.png" alt="在这里插入图片描述"><br><img src="https://i-blog.csdnimg.cn/direct/283356df161649f2b8ca56f9b9694ac6.png" alt="在这里插入图片描述"></p>
<ul>
<li>在 Express 中使用 Session 认证</li>
</ul>
<ol>
<li>安装express-session 中间件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express-session</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置 express-session 中间件<br>express-session 中间件安装成功后，需要通过 app.use() 注册 session 中间件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> session=<span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">	<span class="attr">secret</span>:<span class="string">&#x27;nicai&#x27;</span> <span class="comment">//可以是任意字符串</span></span><br><span class="line">	<span class="attr">resave</span>:<span class="literal">false</span>,<span class="comment">//固定写法</span></span><br><span class="line">	<span class="attr">saveUninitialized</span>:<span class="literal">true</span> <span class="comment">//固定写法</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>向 session 中存数据<br>当 express-session 中间件配置成功后，即可通过 req.session 访问和使用 session 对象，从而存储用户关键信息：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/login&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">username</span>!==<span class="string">&#x27;admin&#x27;</span> || req.<span class="property">body</span>.<span class="property">password</span>!==<span class="string">&#x27;666666&#x27;</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">1</span>,<span class="attr">msg</span>:<span class="string">&#x27;fail&#x27;</span>&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	req.<span class="property">session</span>.<span class="property">user</span>=req.<span class="property">body</span></span><br><span class="line">	req.<span class="property">session</span>.<span class="property">islogin</span>=<span class="literal">true</span></span><br><span class="line">	res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&#x27;success&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>从 session 中取数据<br>从 req.session 对象上获取之前存储的数据</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/username&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">islogin</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">1</span>,<span class="attr">msg</span>:<span class="string">&#x27;fail&#x27;</span>&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="attr">status</span>:<span class="number">0</span>,</span><br><span class="line">		<span class="attr">msg</span>:<span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">		<span class="attr">username</span>:req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">username</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>清空 session<br>调用 req.session.destroy() 函数，即可清空服务器保存的 session 信息。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/logout&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">	req.<span class="property">session</span>.<span class="title function_">destroy</span>()</span><br><span class="line">	res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">0</span>,<span class="attr">msg</span>:<span class="string">&#x27;logout ok&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>Session 认证局限性<br>Session 认证机制需要配合 Cookie 。由于 Cookie 默认不支持跨域访问，当涉及到前端跨域请求后端接口的时候，需要做很多额外配置，才能实现跨域 Session 认证。</li>
<li>总结：<br>当前端请求后端接口不存在跨域问题的时候，推荐使用 Session 身份认证机制。<br>当前端需要跨域请求后端接口的时候，不推荐使用 Session 身份认证机制，推荐使用 JWT 认证机制。</li>
</ul>
<h3 id="JWT-认证机制"><a href="#JWT-认证机制" class="headerlink" title="JWT 认证机制"></a>JWT 认证机制</h3><p>JWT（JSON Web Token）是目前最流行的跨域认证解决方案。<br>工作原理：用户信息通过 Token 字符串形式，保存在客户端浏览器中。服务器通过还原 Token 字符串认证用户身份。</p>
<ul>
<li>优点<br>用户登录成功后，服务器生成一个「签名后的 Token」，返回给前端。<br>前端后续请求带上这个 Token（请求头），服务器验证 Token 就能判断用户身份。<br>✅ 无需服务器保存 Session，更适合前后端分离架构。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/68ded68975d44611b72ea2283a2cd291.png" alt="在这里插入图片描述"></li>
<li>JWT 的组成部分：由三部分组成，分别是 Header（头部）、Payload（有效荷载）、Signature（签名）。三者之间使用英文“.”分隔，格式：<code>Header.Payload.Signature</code><br>其中：<br> Payload 部分才是真正的用户信息，它是用户信息经过加密之后生成的字符串。<br> Header 和 Signature 是安全性相关部分，只是为保证 Token 安全性。<br>Header：<code> &#123; &quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot; &#125;</code>用于指示签名算法和 token 类型。<br>Payload：实际传递信息，例如 username， token 有效负载部分。<br>Signature：用于确保 token 完整性，通过 secretKey 和算法（如 HS256）生成。<br><img src="/images/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A.assets/33d5c2917c954652a6a1cee9887ed9d0.png" alt="在这里插入图片描述"></li>
<li>使用<br>客户端收到服务器返回的 JWT 之后，将它存在 localStorage&#x2F;sessionStorage 中。<br>此后，客户端每次与服务器通信，都要带上这个 JWT 字符串进行身份认证。推荐做法是把 JWT 放在 HTTP 请求头的 Authorization 字段中，格式：<code>Authorization:Bearer &lt;token&gt;</code></li>
<li>Express 中使用 JWT</li>
</ul>
<ol>
<li>安装 JWT 相关的包<br>jsonwebtoken 生成 JWT 字符串<br>express-jwt 将 JWT 字符串解析还原成 JSON 对象</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jsonwebtoken express-jwt</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>导入这两个包</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt=<span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> expressJWT=<span class="built_in">require</span>(<span class="string">&#x27;express-jwt&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>【值要严格保密】专门定义一个用于加密解密的 secret 密钥<br>生成 JWT 字符串：需要使用 secret 密钥对用户信息加密，最终得到加密好的 JWT 字符串<br>把 JWT 字符串解析还原成 JSON 对象，需要使用 secret 密钥解密</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> secretKey=<span class="string">&#x27;jiami key - _ -&#x27;</span><span class="comment">//就是一个字符串</span></span><br><span class="line"><span class="comment">//生产环境请用环境变量保存</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>登录成功后生成JWT字符串<br>调用 jsonwebtoken 包的 sign() 方法，将用户信息加密成 JWT 字符串，响应给客户端：<br><code>jwt.sign()</code>：是 jsonwebtoken 库中用于生成 JWT 的方法。<br><code>&#123; username: userinfo.username &#125;</code>： JWT 的载荷（payload）， token 包含的用户数据。<br><code>secretKey</code>：用于签名 JWT 的密钥。确保生成的 token 只能由具有相同密钥的服务端验证。秘钥必须保密且不可公开。<br><code>&#123; expiresIn: &#39;30s&#39; &#125;</code>：可选配置项，设置 token 过期时间。expiresIn: ‘30s’ 表示该 token 在 30 秒后过期。根据需要调整过期时间，例如 ‘1h’ 表示 1 小时，’7d’ 表示 7 天。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/login&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">	<span class="keyword">const</span> userinfo = req.<span class="property">body</span></span><br><span class="line">  <span class="comment">// 登录失败</span></span><br><span class="line">  <span class="keyword">if</span> (userinfo.<span class="property">username</span> !== <span class="string">&#x27;admin&#x27;</span> || userinfo.<span class="property">password</span> !== <span class="string">&#x27;000000&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: <span class="number">400</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;登录失败！&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">//登录成功</span></span><br><span class="line">	res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="attr">status</span>:<span class="number">200</span>,</span><br><span class="line">		<span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">		<span class="attr">token</span>:jwt.<span class="title function_">sign</span>(&#123;</span><br><span class="line">			<span class="attr">username</span>:userinfo.<span class="property">username</span>,</span><br><span class="line">		&#125;,secretKey,&#123;</span><br><span class="line">			<span class="attr">expiresIn</span>:<span class="string">&#x27;30s&#x27;</span></span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="comment">//jwt.sign生成JWT字符串</span></span><br><span class="line">		<span class="comment">//三个参数分别是 用户信息对象、加密密钥、配置对象</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//编写验证 Token 的中间件</span></span><br><span class="line"><span class="comment">// auth.js</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET</span> = <span class="string">&#x27;abc123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> auth = req.<span class="property">headers</span>[<span class="string">&#x27;authorization&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!auth || !auth.<span class="title function_">startsWith</span>(<span class="string">&#x27;Bearer &#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">code</span>: -<span class="number">1</span>, <span class="attr">msg</span>: <span class="string">&#x27;未登录或格式错误&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> token = auth.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">SECRET</span>);</span><br><span class="line">    req.<span class="property">user</span> = decoded; <span class="comment">// 保存解密后的用户信息</span></span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">code</span>: -<span class="number">1</span>, <span class="attr">msg</span>: <span class="string">&#x27;Token 无效或已过期&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用中间件保护接口</span></span><br><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">&#x27;./auth&#x27;</span>);</span><br><span class="line"><span class="comment">//只有登录成功获取 Token 的用户，才能访问 /user/info。</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/user/info&#x27;</span>, auth, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">user</span>: req.<span class="property">user</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>将 JWT 字符串还原为 JSON 对象<br>客户端每次在访问有权限接口时，都需要主动通过请求头的 Authorization 字段，将 Token 字符串发送到服务器进行身份认证。<br>服务器可通过 express-jwt 中间件，自动将客户端发送过来的 Token 解析还原成 JSON 对象：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app,use()注册中间件</span></span><br><span class="line"><span class="comment">//expressJWT(&#123;secret:secretKey&#125;) 解析token的中间件</span></span><br><span class="line"><span class="comment">//.unless(&#123;path:[/^\/api\//]&#125;)指定哪些接口不需要访问权限</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">expressJWT</span>(&#123;<span class="attr">secret</span>:secretKey&#125;).<span class="title function_">unless</span>(&#123;<span class="attr">path</span>:[<span class="regexp">/^\/api\//</span>]&#125;))</span><br><span class="line"><span class="comment">//不需要访问权限的：/api开头的</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>使用 req.user 获取用户信息<br>express-jwt 中间件配置成功后，可在有权限接口中，使用 req.user 对象，访问从 JWT 字符串中解析出来的用户信息，示例：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/admin/getinfo&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">user</span>)</span><br><span class="line">	res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="attr">status</span>:<span class="number">200</span>,</span><br><span class="line">		<span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">		<span class="attr">data</span>:req.<span class="property">user</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>捕获解析 JWT 失败后产生的错误<br>使用 express-jwt 解析 Token 字符串时，如果客户端发送过来的 Token 字符串过期或不合法，会产生解析失败错误，影响项目正常运行。可以通过 Express 错误中间件，捕获这个错误并进行相关处理，示例：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err,req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(err.<span class="property">name</span>===<span class="string">&#x27;UnauthorizedError&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">401</span>,<span class="attr">msg</span>:<span class="string">&#x27;fail:invalid token&#x27;</span>&#125;)</span><br><span class="line">	res.<span class="title function_">send</span>(&#123;<span class="attr">status</span>:<span class="number">500</span>,<span class="attr">msg</span>:<span class="string">&#x27;error&#x27;</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>实战</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="comment">// 导入配置文件</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="comment">// 解析 token 的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJWT = <span class="built_in">require</span>(<span class="string">&#x27;express-jwt&#x27;</span>)</span><br><span class="line"><span class="comment">// 使用 .unless(&#123; path: [/^\/api\//] &#125;) 指定哪些接口不需要进行 Token 的身份认证</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">expressJWT</span>(&#123; <span class="attr">secret</span>: config.<span class="property">jwtSecretKey</span> &#125;).<span class="title function_">unless</span>(&#123; <span class="attr">path</span>: [<span class="regexp">/^\/api\//</span>] &#125;))</span><br><span class="line"><span class="comment">//注意：注册路由之前，配置解析 Token 的中间件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定義響應處理中間件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 為 res 掛載一個名為 cc 的函數</span></span><br><span class="line">  <span class="comment">// 參數：err - 錯誤物件或錯誤訊息，data - 成功時的數據</span></span><br><span class="line">  res.<span class="property">cc</span> = <span class="keyword">function</span> (<span class="params">err, data = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> status = <span class="number">0</span>; <span class="comment">// 默認成功</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">&#x27;操作成功&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123; <span class="comment">// 如果傳入 err 參數，表示操作失敗</span></span><br><span class="line">      status = <span class="number">1</span>; <span class="comment">// 設置失敗狀態</span></span><br><span class="line">      <span class="comment">// 如果 err 是 Error 物件，取其 message；否則直接使用 err</span></span><br><span class="line">      message = err <span class="keyword">instanceof</span> <span class="title class_">Error</span> ? err.<span class="property">message</span> : err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 發送 JSON 響應</span></span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">status</span>: status,</span><br><span class="line">      <span class="attr">message</span>: message,</span><br><span class="line">      <span class="attr">data</span>: data <span class="comment">// 成功時可以帶數據</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">next</span>(); <span class="comment">// 繼續處理下一個中間件或路由</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//错误级别中间件放最后</span></span><br><span class="line"><span class="comment">// 错误中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">err, req, res, next</span>) &#123;</span><br><span class="line"><span class="comment">// 省略其它...</span></span><br><span class="line"><span class="comment">// 捕获身份认证失败的错误</span></span><br><span class="line"><span class="keyword">if</span> (err.<span class="property">name</span> === <span class="string">&#x27;UnauthorizedError&#x27;</span>) <span class="keyword">return</span> res.<span class="title function_">cc</span>(<span class="string">&#x27;身份认证失败！&#x27;</span>)</span><br><span class="line"><span class="comment">//res.cc是自定义中间件</span></span><br><span class="line"><span class="comment">// 未知错误...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果你发送 form-data 或者类似的表单数据（例如使用 application&#x2F;x-www-form-urlencoded），就不需要设置 Content-Type: application&#x2F;json。默认Content-Type 就是 application&#x2F;x-www-form-urlencoded 或 multipart&#x2F;form-data。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;/api/private&#x27;</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span>, <span class="comment">// 在请求头中加入 token</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">contentType</span>: <span class="string">&#x27;application/json&#x27;</span>, <span class="comment">// 告诉服务器数据是 JSON 格式</span></span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">key</span>: <span class="string">&#x27;value&#x27;</span> &#125;), <span class="comment">// 将数据转换为 JSON 字符串</span></span><br><span class="line">  <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Response Data:&#x27;</span>, response);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">xhr, status, error</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/api/private&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="comment">// 请求方法</span></span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span>, <span class="comment">// 将 token 加入到 Authorization 头部</span></span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>, <span class="comment">// 请求内容类型</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="comment">// 请求体数据</span></span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Response Data:&#x27;</span>, data);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>在生成 Token 字符串的时候，一定要剔除 密码 和 头像 的值；为方便客户端使用 Token，在服务器端直接拼接上 Bearer 的前缀<code>token: &#39;Bearer &#39; + tokenStr</code></li>
<li>使用 bcryptjs 对用户密码加密，优点：<br>加密之后的密码，无法逆向破解<br>同一明文密码多次加密，得到加密结果各不相同，保证安全性</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//加密</span></span><br><span class="line"><span class="keyword">const</span> res=bcrypt.<span class="title function_">hashSync</span>(明文密码, 随机盐的长度) </span><br><span class="line"><span class="comment">// 对用户的密码,进行 bcrype 加密，返回值是加密之后的密码字符串</span></span><br><span class="line">userinfo.<span class="property">password</span> = bcrypt.<span class="title function_">hashSync</span>(userinfo.<span class="property">password</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//比较密码是否一致 返回值是布尔值（true 一致、false 不一致）</span></span><br><span class="line">bcrypt.<span class="title function_">compareSync</span>(用户提交的密码, 数据库中的密码)</span><br><span class="line"><span class="comment">// 用户输入的密码和数据库中存储的密码对比</span></span><br><span class="line"><span class="keyword">const</span> compareResult = bcrypt.<span class="title function_">compareSync</span>(userinfo.<span class="property">password</span>, results[<span class="number">0</span>].<span class="property">password</span>)</span><br><span class="line"><span class="comment">// 如果对比结果等于 false, 则证明用户输入的密码错误</span></span><br><span class="line"><span class="keyword">if</span> (!compareResult) &#123;</span><br><span class="line"><span class="keyword">return</span> res.<span class="title function_">cc</span>(<span class="string">&#x27;登录失败！&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>手动封装函数，利用全局中间件带上它（挂载）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应数据的中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">	<span class="comment">// status = 0 为成功； status = 1 为失败； 默认将 status 的值设置为 1，方便处理失败的情况</span></span><br><span class="line">	res.<span class="property">cc</span> = <span class="keyword">function</span> (<span class="params">err, status = <span class="number">1</span></span>) &#123;</span><br><span class="line">		res.<span class="title function_">send</span>(&#123;</span><br><span class="line">		<span class="comment">// 状态</span></span><br><span class="line">		status,</span><br><span class="line">		<span class="comment">// 状态描述，判断 err 是 错误对象 还是 字符串</span></span><br><span class="line">		<span class="attr">message</span>: err <span class="keyword">instanceof</span> <span class="title class_">Error</span> ? err.<span class="property">message</span> : err,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>表单验证原则：前端验证为辅，后端验证为主，后端永远不要相信前端提交过来的任何内容<br>  单纯使用 if…else… 对数据合法性验证，效率低下、出错率高、维护性差。因此，推荐使用第三方数据验证模块，降低出错率、提高验证的效率与可维护性，让后端程序员把更多的精力放在核心业务逻辑的处理上。所需中间件：<code>@hapi/joi</code>为表单中携带的每个数据项，定义验证规则、<code>@escook/express-joi</code>中间件，实现自动对表单数据验证的功能,通过 express-joi 自动验证 req.body 中文本数据。<ul>
<li>注册思路</li>
</ul>
</li>
</ul>
<ol>
<li>检测表单数据是否合法</li>
<li>检测用户名是否被占用</li>
<li>对密码进行加密处理</li>
<li>插入新用户<ul>
<li>登陆思路</li>
</ul>
</li>
<li>检测表单数据是否合法</li>
<li>根据用户名查询用户是否存在</li>
<li>判断用户输入密码是否正确</li>
<li>生成 JWT 的 Token 字符串</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///schema/user.js</span></span><br><span class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">&#x27;@hapi/joi&#x27;</span>)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* string() 值必须是字符串</span></span><br><span class="line"><span class="comment">* alphanum() 值只能是包含 a-zA-Z0-9 的字符串</span></span><br><span class="line"><span class="comment">* min(length) 最小长度</span></span><br><span class="line"><span class="comment">* max(length) 最大长度</span></span><br><span class="line"><span class="comment">* required() 值是必填项，不能为 undefined</span></span><br><span class="line"><span class="comment">* pattern(正则表达式) 值必须符合正则表达式的规则</span></span><br><span class="line"><span class="comment">* integer()</span></span><br><span class="line"><span class="comment">* email()</span></span><br><span class="line"><span class="comment">* dataUri() 验证图片data:image/png;base64</span></span><br><span class="line"><span class="comment">* allow(&#x27;&#x27;)</span></span><br><span class="line"><span class="comment">* valid(&#x27;已发布&#x27;, &#x27;草稿&#x27;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 用户名的验证规则</span></span><br><span class="line"><span class="keyword">const</span> username = joi.<span class="title function_">string</span>().<span class="title function_">alphanum</span>().<span class="title function_">min</span>(<span class="number">1</span>).<span class="title function_">max</span>(<span class="number">10</span>).<span class="title function_">required</span>()</span><br><span class="line"><span class="comment">// 密码的验证规则</span></span><br><span class="line"><span class="keyword">const</span> password = joi</span><br><span class="line">.<span class="title function_">string</span>()</span><br><span class="line">.<span class="title function_">pattern</span>(<span class="regexp">/^[\S]&#123;6,12&#125;$/</span>)</span><br><span class="line">.<span class="title function_">required</span>()</span><br><span class="line"><span class="comment">// 注册和登录表单的验证规则对象</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">reg_login_schema</span> = &#123;</span><br><span class="line"><span class="comment">// 需要对 req.body 中数据进行验证</span></span><br><span class="line">	<span class="attr">body</span>: &#123;</span><br><span class="line">		username,</span><br><span class="line">		password,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///router/user.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 导入用户路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> userHandler = <span class="built_in">require</span>(<span class="string">&#x27;../router_handler/user&#x27;</span>)</span><br><span class="line"><span class="comment">// 1. 导入验证表单数据的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">&#x27;@escook/express-joi&#x27;</span>)</span><br><span class="line"><span class="comment">// 2. 导入需要的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; reg_login_schema &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../schema/user&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line"><span class="comment">// 3. 在注册新用户的路由中，声明局部中间件，对当前请求中携带的数据进行验证</span></span><br><span class="line"><span class="comment">// 3.1 数据验证通过后，会把这次请求流转给后面的路由处理函数</span></span><br><span class="line"><span class="comment">// 3.2 数据验证失败后，终止后续代码的执行，并抛出一个全局的 Error 错误，进入全局错误级别中间件中进行处理</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/reguser&#x27;</span>, <span class="title function_">expressJoi</span>(reg_login_schema), userHandler.<span class="property">regUser</span>)</span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userHandler.<span class="property">login</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br><span class="line"><span class="comment">//重置密码验证思路</span></span><br><span class="line"><span class="comment">//旧密码与新密码，必须符合密码验证规则，并且新密码不能与旧密码一致</span></span><br><span class="line"><span class="comment">// 验证规则对象 - 重置密码</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">update_password_schema</span> = &#123;</span><br><span class="line"><span class="attr">body</span>: &#123;</span><br><span class="line"><span class="comment">// 使用 password 这个规则，验证 req.body.oldPwd 的值</span></span><br><span class="line"><span class="attr">oldPwd</span>: password,</span><br><span class="line"><span class="comment">// 使用 joi.not(joi.ref(&#x27;oldPwd&#x27;)).concat(password) 规则，验证 req.body.newPwd 的值</span></span><br><span class="line"><span class="comment">// 解读：</span></span><br><span class="line"><span class="comment">// 1. joi.ref(&#x27;oldPwd&#x27;) 表示 newPwd 的值必须和 oldPwd 的值保持一致</span></span><br><span class="line"><span class="comment">// 2. joi.not(joi.ref(&#x27;oldPwd&#x27;)) 表示 newPwd 的值不能等于 oldPwd 的值</span></span><br><span class="line"><span class="comment">// 3. .concat() 用于合并 joi.not(joi.ref(&#x27;oldPwd&#x27;)) 和 password 这两条验证规则</span></span><br><span class="line"><span class="attr">newPwd</span>: joi.<span class="title function_">not</span>(joi.<span class="title function_">ref</span>(<span class="string">&#x27;oldPwd&#x27;</span>)).<span class="title function_">concat</span>(password),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在项目根目录中，新建 router 文件夹，用来存放所有路由 模块【只存放客户端请求与处理函数之间的映射关系】；在项目根目录中，新建 router_handler 文件夹，用来存放所有的 路由处理函数模块【只存放每个路由对应的处理函数】</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /router_handler/user.js</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 在这里定义和用户相关的路由处理函数，供 /router/user.js 模块进行调用</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 注册用户的处理函数</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">regUser</span> = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;reguser OK&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 登录的处理函数</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">login</span> = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	res.<span class="title function_">send</span>(<span class="string">&#x27;login OK&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///router/user.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>()</span><br><span class="line"><span class="comment">// 导入用户路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> userHandler = <span class="built_in">require</span>(<span class="string">&#x27;../router_handler/user&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/reguser&#x27;</span>, userHandler.<span class="property">regUser</span>)</span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userHandler.<span class="property">login</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>
<h1 id="dotenv-管理环境变量"><a href="#dotenv-管理环境变量" class="headerlink" title="dotenv 管理环境变量"></a>dotenv 管理环境变量</h1><ul>
<li>定义：项目配置信息</li>
</ul>
<table>
<thead>
<tr>
<th>用途</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>数据库连接地址</td>
<td><code>MONGO_URL=mongodb://...</code></td>
</tr>
<tr>
<td>JWT 密钥</td>
<td><code>JWT_SECRET=xxxxxx</code></td>
</tr>
<tr>
<td>端口配置</td>
<td><code>PORT=3000</code></td>
</tr>
<tr>
<td>第三方服务密钥</td>
<td><code>API_KEY=xxxxx</code></td>
</tr>
</tbody></table>
<ul>
<li>作用：安全性高、灵活性强、便于部署</li>
<li>安装 <code>npm install dotenv</code></li>
<li>使用</li>
</ul>
<ol>
<li>创建 .env 文件（放在项目根目录）</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PORT=5000</span><br><span class="line">MONGO_URL=mongodb://localhost:27017/demo</span><br><span class="line">JWT_SECRET=my-secret-key</span><br></pre></td></tr></table></figure>
<p>.env 不要上传到 GitHub，在 .gitignore 中加入<code>.env</code><br>2. 在入口文件加载 .env</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line">process=<span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).<span class="title function_">config</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">PORT</span>);        <span class="comment">// 5000</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>);  <span class="comment">// my-secret-key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//应用到实际逻辑中</span></span><br><span class="line"><span class="comment">// 使用环境变量连接数据库</span></span><br><span class="line">mongoose.<span class="title function_">connect</span>(process.<span class="property">env</span>.<span class="property">MONGO_URL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用环境变量设置端口</span></span><br><span class="line">app.<span class="title function_">listen</span>(process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用环境变量签发 JWT</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123; id &#125;, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>, &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="文件上传-multer"><a href="#文件上传-multer" class="headerlink" title="文件上传 multer"></a>文件上传 multer</h1><ul>
<li>multipart&#x2F;form-data 格式的请求体数据：使用 multer 解析表单数据<br><strong>注意：使用 express.urlencoded() 中间件无法解析 multipart&#x2F;form-data 格式的请求体数据</strong><br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/multer">https://www.npmjs.com/package/multer</a></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//安装略</span></span><br><span class="line"><span class="comment">///router_handler/article.js</span></span><br><span class="line"><span class="comment">// 导入解析 formdata 格式表单数据的包</span></span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>)</span><br><span class="line"><span class="comment">// 导入处理路径的核心模块</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="comment">// 创建 multer 的实例对象，通过 dest 属性指定文件的存放路径</span></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123; <span class="attr">dest</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>) &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新文章的路由</span></span><br><span class="line"><span class="comment">// upload.single() 是局部生效的中间件，用来解析 FormData 格式的表单数据</span></span><br><span class="line"><span class="comment">// 将文件类型的数据，解析并挂载到 req.file 属性中</span></span><br><span class="line"><span class="comment">// 将文本类型的数据，解析并挂载到 req.body 属性中</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/add&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;cover_img&#x27;</span>), article_handler.<span class="property">addArticle</span>)</span><br><span class="line"><span class="comment">//article_handler.addArticle 最终处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//加入验证规则</span></span><br><span class="line"><span class="comment">///router_handler/article.js</span></span><br><span class="line"><span class="comment">// 导入验证数据的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">&#x27;@escook/express-joi&#x27;</span>)</span><br><span class="line"><span class="comment">// 导入文章的验证模块</span></span><br><span class="line"><span class="keyword">const</span> &#123; add_article_schema &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../schema/article&#x27;</span>)</span><br><span class="line"><span class="comment">// 发布新文章的路由</span></span><br><span class="line"><span class="comment">// 注意：在当前的路由中，先后使用了两个中间件：</span></span><br><span class="line"><span class="comment">// 先使用 multer 解析表单数据</span></span><br><span class="line"><span class="comment">// 再使用 expressJoi 对解析的表单数据进行验证</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/add&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;cover_img&#x27;</span>), <span class="title function_">expressJoi</span>(add_article_schema),</span><br><span class="line">article_handler.<span class="property">addArticle</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//整理要插入数据库的文章信息对象</span></span><br><span class="line"><span class="comment">//里面存的文件不是文件本身，而是其存放地址</span></span><br><span class="line"><span class="comment">// 导入处理路径的 path 核心模块</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> articleInfo = &#123;</span><br><span class="line"><span class="comment">// 标题、内容、状态、所属的分类Id</span></span><br><span class="line">...req.<span class="property">body</span>,</span><br><span class="line"><span class="comment">// 文章封面在服务器端的存放路径</span></span><br><span class="line"><span class="attr">cover_img</span>: path.<span class="title function_">join</span>(<span class="string">&#x27;/uploads&#x27;</span>, req.<span class="property">file</span>.<span class="property">filename</span>),</span><br><span class="line"><span class="comment">// 文章发布时间</span></span><br><span class="line"><span class="attr">pub_date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line"><span class="comment">// 文章作者的Id</span></span><br><span class="line"><span class="attr">author_id</span>: req.<span class="property">user</span>.<span class="property">id</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//app.js 中，使用 express.static() 中间件，将 uploads 目录中的图片托管为静态资源</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/uploads&#x27;</span>, express.<span class="title function_">static</span>(<span class="string">&#x27;./uploads&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h1 id="Swagger-自动生成接口文档"><a href="#Swagger-自动生成接口文档" class="headerlink" title="Swagger 自动生成接口文档"></a>Swagger 自动生成接口文档</h1><ul>
<li>定义：Swagger 是一套RESTful API 接口文档规范。配合 swagger-ui-express 和 swagger-jsdoc</li>
</ul>
<table>
<thead>
<tr>
<th>能力</th>
<th>技术点</th>
</tr>
</thead>
<tbody><tr>
<td>文档生成</td>
<td><code>swagger-jsdoc</code></td>
</tr>
<tr>
<td>文档 UI 展示</td>
<td><code>swagger-ui-express</code></td>
</tr>
<tr>
<td>注释定义 API</td>
<td>JSDoc 风格 <code>@swagger</code> 注解</td>
</tr>
</tbody></table>
<ul>
<li>优点<br>自动生成在线接口文档<br>支持文档自动同步更新<br>支持接口在线测试<br>非常适合前后端联调</li>
<li>安装 <code>npm install swagger-jsdoc swagger-ui-express</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录结构</span></span><br><span class="line">project/</span><br><span class="line">├── app.js</span><br><span class="line">├── swagger/</span><br><span class="line">│   └── swaggerConfig.js</span><br></pre></td></tr></table></figure>
<ul>
<li>使用</li>
</ul>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>@swagger</code></td>
<td>开始一段 API 描述</td>
</tr>
<tr>
<td><code>summary</code></td>
<td>接口功能描述</td>
</tr>
<tr>
<td><code>tags</code></td>
<td>接口归类（如 User）</td>
</tr>
<tr>
<td><code>parameters</code></td>
<td>请求参数说明（支持 query&#x2F;path）</td>
</tr>
<tr>
<td><code>requestBody</code></td>
<td>请求体（POST）</td>
</tr>
<tr>
<td><code>responses</code></td>
<td>返回结构说明</td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置 Swagger 基本信息</span></span><br><span class="line"><span class="comment">//swagger/swaggerConfig.js</span></span><br><span class="line"><span class="keyword">const</span> swaggerJSDoc = <span class="built_in">require</span>(<span class="string">&#x27;swagger-jsdoc&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  <span class="attr">definition</span>: &#123;</span><br><span class="line">    <span class="attr">openapi</span>: <span class="string">&#x27;3.0.0&#x27;</span>, <span class="comment">// OpenAPI 规范版本</span></span><br><span class="line">    <span class="attr">info</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;用户接口文档&#x27;</span>,</span><br><span class="line">      <span class="attr">version</span>: <span class="string">&#x27;1.0.0&#x27;</span>,</span><br><span class="line">      <span class="attr">description</span>: <span class="string">&#x27;基于 Express + Swagger 的接口文档示例&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">apis</span>: [<span class="string">&#x27;./routes/*.js&#x27;</span>], <span class="comment">// 扫描所有带注释的路由文件</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> swaggerSpec = <span class="title function_">swaggerJSDoc</span>(options);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = swaggerSpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">//挂载 Swagger UI 到服务中</span></span><br><span class="line"><span class="comment">//app.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> swaggerUi = <span class="built_in">require</span>(<span class="string">&#x27;swagger-ui-express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> swaggerSpec = <span class="built_in">require</span>(<span class="string">&#x27;./swagger/swaggerConfig&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api-docs&#x27;</span>, swaggerUi.<span class="property">serve</span>, swaggerUi.<span class="title function_">setup</span>(swaggerSpec));</span><br><span class="line"><span class="comment">//访问文档地址：http://localhost:3000/api-docs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在路由中添加注释（支持 JSDoc 风格）</span></span><br><span class="line"><span class="comment">//routes/user.js</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@swagger</span></span></span><br><span class="line"><span class="comment"> * /users:</span></span><br><span class="line"><span class="comment"> *   get:</span></span><br><span class="line"><span class="comment"> *     summary: 获取所有用户</span></span><br><span class="line"><span class="comment"> *     tags: [User]</span></span><br><span class="line"><span class="comment"> *     responses:</span></span><br><span class="line"><span class="comment"> *       200:</span></span><br><span class="line"><span class="comment"> *         description: 成功返回用户列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, auth, userController.<span class="property">getAllUsers</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@swagger</span></span></span><br><span class="line"><span class="comment"> * /users/&#123;id&#125;:</span></span><br><span class="line"><span class="comment"> *   get:</span></span><br><span class="line"><span class="comment"> *     summary: 获取指定用户</span></span><br><span class="line"><span class="comment"> *     tags: [User]</span></span><br><span class="line"><span class="comment"> *     parameters:</span></span><br><span class="line"><span class="comment"> *       - in: path</span></span><br><span class="line"><span class="comment"> *         name: id</span></span><br><span class="line"><span class="comment"> *         required: true</span></span><br><span class="line"><span class="comment"> *         description: 用户ID</span></span><br><span class="line"><span class="comment"> *         schema:</span></span><br><span class="line"><span class="comment"> *           type: string</span></span><br><span class="line"><span class="comment"> *     responses:</span></span><br><span class="line"><span class="comment"> *       200:</span></span><br><span class="line"><span class="comment"> *         description: 成功返回用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/:id&#x27;</span>, auth, userController.<span class="property">getUserById</span>);</span><br></pre></td></tr></table></figure>
<h1 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h1><h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><ul>
<li>服务端nodejs文件需要启动<code>node app.js</code><br>尽管服务端nodejs文件和pages文件在同一个文件夹中 他们开启后地址和端口可能不同<br>用server.address()查看服务端地址，有两种地址 ipv4和ipv6的<br>直接用 <a href="http://localhost:3000，因为">http://localhost:3000，因为</a> localhost 通常解析为 ::1（IPv6）或 127.0.0.1（IPv4），浏览器会自动选。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span></span><br><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(<span class="number">5500</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//console.log(&#x27;Express server running at http://127.0.0.1:5500&#x27;)</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(server.<span class="title function_">address</span>())</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  server.address() 会返回地址信息，格式可能是：</span></span><br><span class="line"><span class="comment">&#123; address: &#x27;::&#x27;, port: 3000, family: &#x27;IPv6&#x27; &#125;（就是本地 IPv6，浏览器用 localhost 访问）</span></span><br><span class="line"><span class="comment">&#123; address: &#x27;127.0.0.1&#x27;, port: 3000, family: &#x27;IPv4&#x27; &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听所有地址</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27; Server running on http://localhost:3000 (or your IP address)&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>需要让局域网其他设备访问，就要监听 0.0.0.0 或使用你本机 IPv4 地址</p>
<ul>
<li>如果在 Express 中用 req.body，但没加中间件，也可能导致请求异常404</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>()); <span class="comment">// 必须加</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Express 使用 req.session 保存数据，但之后请求别的接口时之前存好的 session 内容丢失<br>超级常见坑,首先查看session是否存在</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Session:&#x27;</span>, req.<span class="property">session</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol>
<li>没有设置&#x2F;保持 Cookie<br>Session 是依赖浏览器 cookie 存的，如果 cookie 没传过来，服务端就拿不到之前的 session。<br>浏览器得保留 connect.sid（默认名字）这个 cookie<br>前端请求得带上 cookie（特别是跨域时）</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fetch</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://localhost:3000/api/xxx&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">credentials</span>: <span class="string">&#x27;include&#x27;</span> <span class="comment">// 必须有！！！</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// jQuery</span></span><br><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;http://localhost:3000/api/xxx&#x27;</span>,</span><br><span class="line">  <span class="attr">xhrFields</span>: &#123;</span><br><span class="line">    <span class="attr">withCredentials</span>: <span class="literal">true</span> <span class="comment">// 也必须有！</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>在 jQuery 的 $.get 和 $.post 请求中，默认是会带上当前页面域名下 cookie ，只要满足以下条件：带上 cookie 的前提条件<br>请求是同源的（Same Origin）<br>没有设置为跨域并且没有手动禁用 cookie<br>如果是跨域请求（比如从 example.com 请求 api.example.com）：需要用 $.ajax 并加上 xhrFields: { withCredentials: true }，而且服务器也要允许带 cookie。</li>
</ul>
<ol start="2">
<li>跨域请求但没设置 CORS 允许携带 cookie</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>(&#123;</span><br><span class="line">  <span class="attr">origin</span>: <span class="string">&#x27;http://localhost:5173&#x27;</span>, <span class="comment">// 你的前端地址</span></span><br><span class="line">  <span class="attr">credentials</span>: <span class="literal">true</span><span class="comment">//允许</span></span><br><span class="line">  <span class="comment">//如果没 credentials: true，cookie 就不会被带上，session 就断了。</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>session 中间件没正确配置<br>secure: true 只能在 HTTPS 下设置，否则 cookie 不会保存<br>saveUninitialized: true 保证新用户也能有 session</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">  <span class="attr">secret</span>: <span class="string">&#x27;your-secret&#x27;</span>,</span><br><span class="line">  <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">saveUninitialized</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">cookie</span>: &#123;</span><br><span class="line">    <span class="attr">secure</span>: <span class="literal">false</span>, <span class="comment">// 本地开发必须是 false，https 才设 true</span></span><br><span class="line">    <span class="attr">maxAge</span>: <span class="number">60000</span> <span class="comment">// 可选 单位：毫秒</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>服务器是无状态的，比如重新部署或重启，或多个服务器没共享 session<br>如果你每次请求都打到不同服务器，session 存在内存里肯定丢。解决方法：<br>用 Redis 作为 session 存储：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">RedisStore</span> = <span class="built_in">require</span>(<span class="string">&#x27;connect-redis&#x27;</span>)(session);</span><br><span class="line"><span class="comment">// 设置 store: new RedisStore(&#123;...&#125;)</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>静态资源也可能导致 session 丢失<br>如果用 app.use(express.static(…))，要小心它在路由匹配前就返回了响应，可能导致 session 相关逻辑没执行。</li>
<li>是不是用 localhost:3000 和 IP 地址混用？<br><a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> ≠ <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/">http://127.0.0.1:3000</a><br>Cookie 是绑定域名的，切换域名或 IP，cookie 就丢了。<br>建议：前后端都用 localhost 或都用 IP，不能混。</li>
<li>手动设置cookie<br>浏览器通过服务器响应中的 Set-Cookie 头来接收并存储 cookie。<br>跨站点 Cookie 限制: 现代浏览器对第三方 cookies 有严格的限制，尤其是跨站请求时。如果 cookie 是第三方 cookie（例如通过 iframe 或跨域请求发送），浏览器可能拒绝存储这些 cookie。可以考虑将 SameSite&#x3D;None，并确保使用 HTTPS 和 Secure。<br>cookie 的 Path&#x3D;&#x2F; 表示全站有效，如果没有设置正确的路径，浏览器可能不会在其他页面存储它。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//手动设置cookie</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/set-cookie&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">cookie</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;value&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">httpOnly</span>: <span class="literal">true</span>,  <span class="comment">// cookie 只能通过 HTTP 访问</span></span><br><span class="line">    <span class="attr">secure</span>: <span class="literal">true</span>,    <span class="comment">// 只在 HTTPS 下发送 cookie</span></span><br><span class="line">    <span class="attr">sameSite</span>: <span class="string">&#x27;Lax&#x27;</span>, <span class="comment">// 在跨站请求时仍然发送 cookie</span></span><br><span class="line">    <span class="attr">maxAge</span>: <span class="number">3600000</span>  <span class="comment">// 设置 cookie 1 小时后过期</span></span><br><span class="line">  &#125;);</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;Cookie has been set&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>safari浏览器：如果必须跨域 + HTTP，就别指望 Safari 存 cookie<br>用 Safari 打开开发者工具 → Network → 看响应的 Set-Cookie 是否显示<br>关闭 Safari → 偏好设置 → 隐私-&gt;取消勾选「防止跨网站追踪」</li>
</ol>
<ul>
<li>现在npm包mysql已升级到mysql2<br>如果不升级 直接用mysql包 会导致报错 无法操作数据库<br>ER_NOT_SUPPORTED_AUTH_MODE: Client does not support authentication protocol requested by server; consider upgrading MySQL client”<br>你用的 MySQL 客户端不支持当前 MySQL 服务器所使用的用户认证方式。<br>从 MySQL 8.0 开始，默认的认证插件改为：caching_sha2_password，而老的 MySQL 客户端（或一些库，比如 mysql npm 包）默认只支持：mysql_native_password<br>如何解决？</li>
</ul>
<ol>
<li>把数据库用户认证方式切换成老的 mysql_native_password<br>执行如下命令修改用户认证插件</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;你的密码&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>替代方案：升级 Node.js MySQL 客户端【安全性更高】<br>如果使用mysql 包，建议升级为：mysql2，它支持 caching_sha2_password<br>使用说明详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41775119/article/details/147152712?fromshare=blogdetail&sharetype=blogdetail&sharerId=147152712&sharerefer=PC&sharesource=qq_41775119&sharefrom=from_link">点击跳转</a></li>
</ol>
<h2 id="简易-CLI-工具（process-argv）"><a href="#简易-CLI-工具（process-argv）" class="headerlink" title="简易 CLI 工具（process.argv）"></a>简易 CLI 工具（process.argv）</h2><ul>
<li>CLI工具定义：Command Line Interface Tools，通过文字命令操作工具</li>
<li>作用：高效</li>
</ul>
<h2 id="图床服务"><a href="#图床服务" class="headerlink" title="图床服务"></a>图床服务</h2><p>上传图片，返回图片链接（用 multer 实现）</p>
<h2 id="API-转发代理服务"><a href="#API-转发代理服务" class="headerlink" title="API 转发代理服务"></a>API 转发代理服务</h2><p>Node 服务转发请求到另一个第三方接口，加权限鉴权：<br>身份验证（Authentication）：验证用户是否已登录，通常基于 Token（如 JWT）、Session、Cookie 等。<br>权限授权（Authorization）：判断用户是否有权限访问某个资源或执行某个操作。<br>封装成中间件：只需 app.use(authMiddleware)，即可自动保护所需接口。<br>配置可定制：支持白名单接口、角色控制、动态规则等。<br>易集成、可扩展：可以在 Express、Koa 等框架中灵活接入。</p>
<ul>
<li>最简单的实现：http-proxy-middleware（适用于 Express）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 /api 的请求代理到 http://backend-server.com</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/api&#x27;</span>, <span class="title function_">createProxyMiddleware</span>(&#123;</span><br><span class="line">  <span class="attr">target</span>: <span class="string">&#x27;http://backend-server.com&#x27;</span>,</span><br><span class="line">  <span class="attr">changeOrigin</span>: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Proxy server is running on http://localhost:3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="开发Node监控平台中间件"><a href="#开发Node监控平台中间件" class="headerlink" title="开发Node监控平台中间件"></a>开发Node监控平台中间件</h2><ul>
<li>功能<br>请求日志采集：记录每个 HTTP 请求的时间、路径、状态码、响应时间等，便于问题定位。<br>错误监控与报警：捕获运行时异常，并上报到监控系统，比如 Sentry、Logstash 等，一旦触发特定规则还能自动通知。<br>性能分析：监控接口响应时间、内存使用、事件循环延迟等，帮助开发者优化性能。<br>健康检查接口：提供标准的 &#x2F;health 或类似接口供外部系统定期检查服务状态。</li>
</ul>
<h2 id="小型Node框架搭建"><a href="#小型Node框架搭建" class="headerlink" title="小型Node框架搭建"></a>小型Node框架搭建</h2><p>类似express koa但是更轻更可控、可自定义</p>
<ul>
<li>功能<br>处理 HTTP 请求：比如支持 GET、POST 请求，解析 URL、参数等。<br>设计中间件机制：像 Express 那样允许你插入“插件函数”，做日志记录、权限控制等。<br>路由功能：根据请求路径和方法，分发给不同的处理函数。<br>响应封装：设置状态码、响应头、返回 JSON 等。<br>错误处理机制：统一捕获错误并输出提示。</li>
</ul>
<h2 id="用户管理系统（Node-Express-MongoDB）"><a href="#用户管理系统（Node-Express-MongoDB）" class="headerlink" title="用户管理系统（Node + Express + MongoDB）"></a>用户管理系统（Node + Express + MongoDB）</h2><p>功能：注册、登录、获取用户列表、JWT 鉴权</p>
<h1 id="Node-js-高级能力"><a href="#Node-js-高级能力" class="headerlink" title="Node.js 高级能力"></a>Node.js 高级能力</h1><p>异步控制（Promise、async&#x2F;await）用法跟JS一模一样，但要注意node API异步操作也需要.then&#x2F;.catch&#x2F;async&#x2F;await，如文件读写fs.readFile、数据库操作、网络请求等</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>工具</th>
</tr>
</thead>
<tbody><tr>
<td>✅ 单元测试（Unit Test）</td>
<td>测试函数、组件是否正确输出</td>
<td>Jest, Vitest</td>
</tr>
<tr>
<td>✅ 组件测试（Component Test）</td>
<td>测 Vue&#x2F;React 组件是否正常渲染</td>
<td>Vue Testing Library, React Testing Library</td>
</tr>
<tr>
<td>🔶 E2E 测试（End to End）</td>
<td>模拟用户完整点击流程</td>
<td>Playwright, Cypress</td>
</tr>
<tr>
<td>🔶 快照测试（Snapshot）</td>
<td>比较 UI 或数据结构有没有变</td>
<td>Jest Snapshots</td>
</tr>
<tr>
<td>🔶 Mock 测试</td>
<td>模拟 API 响应</td>
<td>MSW（Mock Service Worker）</td>
</tr>
</tbody></table>
<p>最重要是前两个，后续深入单开一坑</p>
<ul>
<li>Jest</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sum.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sum</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = sum;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sum.test.js</span></span><br><span class="line"><span class="keyword">const</span> sum = <span class="built_in">require</span>(<span class="string">&#x27;./sum&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;加法 1 + 2 应该等于 3&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">sum</span>(<span class="number">1</span>, <span class="number">2</span>)).<span class="title function_">toBe</span>(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//终端运行npx jest</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Vue Testing Library</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Hello.vue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;count++&quot;</span>&gt;</span>Clicked &#123;&#123; count &#125;&#125; times<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hello.test.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; render, fireEvent &#125; <span class="keyword">from</span> <span class="string">&#x27;@testing-library/vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Hello</span> <span class="keyword">from</span> <span class="string">&#x27;./Hello.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;点击按钮会增加计数&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; getByText &#125; = <span class="title function_">render</span>(<span class="title class_">Hello</span>)<span class="comment">//在测试环境里模拟的 DOM</span></span><br><span class="line">  <span class="keyword">const</span> button = <span class="title function_">getByText</span>(<span class="string">&#x27;Clicked 0 times&#x27;</span>)</span><br><span class="line">  <span class="comment">//getByText()查询工具，用来找页面中含有特定文字的元素</span></span><br><span class="line">  <span class="comment">//如果找不到这个文字，测试就失败。</span></span><br><span class="line">  <span class="keyword">await</span> fireEvent.<span class="title function_">click</span>(button)</span><br><span class="line">  <span class="comment">//模拟用户点击按钮</span></span><br><span class="line">  <span class="comment">//加 await 是因为 click 之后 Vue 会异步更新 DOM。</span></span><br><span class="line">  <span class="title function_">getByText</span>(<span class="string">&#x27;Clicked 1 times&#x27;</span>) <span class="comment">// 会报错就说明失败</span></span><br><span class="line">  <span class="comment">//更精准的断言</span></span><br><span class="line">  <span class="title function_">expect</span>(<span class="title function_">getByText</span>(<span class="string">&#x27;Clicked 1 times&#x27;</span>)).<span class="title function_">toBeTruthy</span>()</span><br><span class="line">  <span class="title function_">expect</span>(button.<span class="property">textContent</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;Clicked 1 times&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="服务部署（PM2-Docker）"><a href="#服务部署（PM2-Docker）" class="headerlink" title="服务部署（PM2 &#x2F; Docker）"></a>服务部署（PM2 &#x2F; Docker）</h2><ul>
<li>PM2 是一个 Node.js 应用进程管理器，可以帮你「常驻运行项目」、「自动重启」、「支持日志」、「集群部署」。<br>使用场景：</li>
</ul>
<table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>启动 Node 服务</td>
<td>不再用 <code>node app.js</code>，而是用 <code>pm2 start app.js</code></td>
</tr>
<tr>
<td>项目奔溃自动恢复</td>
<td>程序崩了自动重启</td>
</tr>
<tr>
<td>开机自启动</td>
<td>设置完，重启服务器自动上线</td>
</tr>
<tr>
<td>线上日志查看</td>
<td>支持 <code>pm2 logs</code> 快速查看运行日志</td>
</tr>
<tr>
<td>多核负载均衡</td>
<td><code>pm2 start app.js -i max</code> 启多个进程（可选）</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">npm install -g pm2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">pm2 start app.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有服务状态</span></span><br><span class="line">pm2 list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">pm2 logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">pm2 restart app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">pm2 stop app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除服务</span></span><br><span class="line">pm2 delete app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存服务列表（断电/重启后生效）</span></span><br><span class="line">pm2 save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机启动配置（一次性操作）</span></span><br><span class="line">pm2 startup</span><br><span class="line"></span><br><span class="line"><span class="comment">#带配置文件管理服务</span></span><br><span class="line">pm2 start ecosystem.config.js</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ecosystem.config.js 配置文件</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">apps</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;my-app&#x27;</span>,</span><br><span class="line">      <span class="attr">script</span>: <span class="string">&#x27;./app.js&#x27;</span>,</span><br><span class="line">      <span class="attr">instances</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">watch</span>: <span class="literal">true</span>, <span class="comment">// 自动重启</span></span><br><span class="line">      <span class="attr">env</span>: &#123;</span><br><span class="line">        <span class="attr">NODE_ENV</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">env_production</span>: &#123;</span><br><span class="line">        <span class="attr">NODE_ENV</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Docker 详见<a target="_blank" rel="noopener" href="https://wyoyo.blog.csdn.net/article/details/145954267?fromshare=blogdetail&sharetype=blogdetail&sharerId=145954267&sharerefer=PC&sharesource=qq_41775119&sharefrom=from_link">点击跳转专题</a></li>
</ul>
<h2 id="SSR、构建工具背后原理（Vite-Webpack-的插件机制）"><a href="#SSR、构建工具背后原理（Vite-Webpack-的插件机制）" class="headerlink" title="SSR、构建工具背后原理（Vite &#x2F; Webpack 的插件机制）"></a>SSR、构建工具背后原理（Vite &#x2F; Webpack 的插件机制）</h2><p> 插件机制本质：钩子 Hook + 生命周期<br>本质都是注册到特定生命周期钩子上</p>

            </div>
        </div>
    </article>

    
    
<nav class="article-nav">
  
    <a href="/2025/07/16/nodejs%E6%A8%A1%E5%9D%97%E5%A4%A7%E5%85%A8/" id="article-nav-newer" class="article-nav-link-wrap prev">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          nodejs模块大全
        
      </div>
    </a>
  
  
    <a href="/2025/07/14/docker%E4%B8%80%E6%9C%AC%E9%80%9A/" id="article-nav-older" class="article-nav-link-wrap next">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">docker一本通 + nginx</div>
    </a>
  
</nav>

    

    
</div>
    </div>
    <footer class="site-footer">
        <div class="global-width">
            <ul class="site-widget">
                
                <li class="widget widget-tag">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/English/" rel="tag">English</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/basics/" rel="tag">basics</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/frontend/" rel="tag">frontend</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/projects/" rel="tag">projects</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tags/" rel="tag">tags</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-category">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/daily-report/">daily_report</a><span class="category-list-count">52</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-recent_posts">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-body">
      <ul>
        
          <li>
            <a href="/2025/07/16/nodejs%E6%A8%A1%E5%9D%97%E5%A4%A7%E5%85%A8/">nodejs模块大全</a>
          </li>
        
          <li>
            <a href="/2025/07/15/nodejs%E4%B8%80%E6%9C%AC%E9%80%9A/">nodejs一本通</a>
          </li>
        
          <li>
            <a href="/2025/07/14/docker%E4%B8%80%E6%9C%AC%E9%80%9A/">docker一本通 + nginx</a>
          </li>
        
          <li>
            <a href="/2025/07/12/%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/">包管理工具</a>
          </li>
        
          <li>
            <a href="/2025/07/11/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D%E4%B8%8E%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80/">移动端适配与响应式布局</a>
          </li>
        
      </ul>
    </div>
  </div>

                </li>
                
            </ul>
        </div>
        <div class="site-info">
            <address>
                &copy; 2014 <a href="https://70v-yoyo.github.io">Yoyo&#39;s blog</a> All Right Reserved. <br/>
                Powered by <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>. Theme by <a target="_blank" rel="noopener" href="http://zzoman.com">ZZOMAN</a>
                <p><a target="_blank" href="https://github.com/70v-Yoyo">My github</a></p>
            </address>
        </div>
    </footer> 
    
    
    <script src="/libs/jquery-1.11.3.min.js" type="text/javascript"></script>
    
    <script src="/libs/fancybox/jquery.fancybox.js" type="text/javascript"></script>
    
    <script src="/js/site_init.js" type="text/javascript"></script>
     
    <noscript>
        <style>
            article {
                position: absolute;
                width: 0;
                height: 0;
                overflow: hidden;
                opacity: 0;
            }

        </style>
        <h1>JS已被禁用</h1>
    </noscript>
<!-- hexo injector body_end start -->
    <script>
      (function() {
        function moveElementIfSmallScreen() {
          const toc = document.getElementById('fixed-toc-container');
          const article = document.querySelector("article");
          const toggleBtn = document.getElementById('toggle_btn');
          if (!toc || !article) return;
          if (window.innerWidth < 1024 && article.firstElementChild !== toc) {
            console.log('small screen!!')
            
            article.insertBefore(toc, article.firstChild);//移动节点，而非复制
            
            toggleBtn.style.display='none';
            // 替换样式：取消 fixed，设置适合正文的样式
            toc.style.position = 'relative';
            toc.style.top = '';
            toc.style.left = '';
            toc.style.width = '100%';
            toc.style.maxHeight = 'none';
            toc.style.overflowY = 'visible';
            toc.style.overflowX = 'visible';
            toc.style.padding = '1em';
            toc.style.borderLeft = 'none';
            toc.style.borderBottom = '1px solid #ddd';
            toc.style.background = '#f9f9f9';
            toc.style.opacity = '1';
            toc.style.zIndex = '9999';
            toc.style.boxShadow = 'none';
            toc.style.margin = '1rem';
            toc.style.paddingTop= '2rem';
          }
        }
        window.addEventListener("DOMContentLoaded", moveElementIfSmallScreen);
        window.addEventListener("resize", moveElementIfSmallScreen);
      })();
    </script>
  <!-- hexo injector body_end end -->
    <div id="fixed-toc-container" style="
      position: fixed;
      top: 0vh;
      left: 0px;
      width: 15rem;
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 10px;
      border-left: 2px solid #ccc;
      font-size: 14px;
      line-height: 1.5;
      background: #fff;
      opacity:0.8;
      z-index: 9999;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.05),  /* 第一层：近处柔和 */
        0 8px 16px rgba(0, 0, 0, 0.08); /* 第二层：远处扩散 */
    ">
      <strong>Contents</strong>
      <div id="toggle_btn" style="
      position:absolute;
      right:1rem;
      display:inline-block;
      width:2rem;
      text-align:center;
      border:1px solid #ccc;
      "><</div>
      <ul id="fixed-toc-list" style="list-style: none; padding-left: 10px;"></ul>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const nav = document.querySelector('nav');
        if (nav) {
          const navBottom = nav.getBoundingClientRect().bottom;//浏览器JS API
          console.log('nav bottom:', navBottom);
          // 设置toc元素 top = nav bottom
          const toc = document.querySelector('#fixed-toc-container');
          if (toc) {
            toc.style.top = navBottom + 'px';
            toc.style.maxHeight=window.innerHeight - navBottom.getBoundingClientRect().bottom;
          }
        }
      });

      const myDiv = document.getElementById('toggle_btn');
      var tocList=document.getElementById("fixed-toc-list");
      var tocContainer=document.getElementById("fixed-toc-container");
      function handleClickBtn() {
        console.log('Div 被点击了！');
        if(myDiv.textContent==='<'){
          myDiv.textContent ='>'
          tocList.style.display='none'
          tocContainer.style.width='11rem'
        }else{
          myDiv.textContent ='<'
          tocList.style.display='block'
          tocContainer.style.width='15rem'
        }
          
      }


      myDiv.addEventListener('click', handleClickBtn);// 绑定点击事件


      (function() {
      const Patternstr = "/*\\d{4}/\\d{2}/\\d{2}/.*"; //本身是字符串插入，所以对符号要转义
      //"^//*"->"/"
      //"/.*"->".*"
      //JS引擎中""转义
      //正则表达式引擎也是""转义
      const dataPattern = new RegExp(Patternstr);
      const path = window.location.pathname;
      console.log(dataPattern.toString(),path,dataPattern.test(path));//控制台在渲染时省略了反斜杠的可视表示。
      if (!dataPattern.test(path)&&(path==='/'||path==='index.html')) {
        console.log('no toc')
        let toc = document.getElementById('fixed-toc-container');
        if (toc) toc.style.display = 'none';
        return;
      }
        var content = document.querySelector('body');
        console.log('content',content)
        //var tocList = document.getElementById('fixed-toc-list');
        if (!content || !tocList) {
          document.getElementById('fixed-toc-container').style.display = 'none';
          return;
        }
        var headings = content.querySelectorAll('h1, h2, h3, h4');
        console.log('headings',headings)
        if(headings){
          const h1Element=headings[0];
          const rect = h1Element.getBoundingClientRect();
          if(rect.left<150){
           tocContainer.style.right='0px';
           tocContainer.style.left = 'auto'; // 移除内联的 left 样式
            //不是设置right:0 就替换left:0 需要移除
            console.log('to right')
          }
          console.log(rect.left,'150')
        }
        
        if (headings.length === 0) {
          document.getElementById('fixed-toc-container').style.display = 'none';
          return;
        }
        headings.forEach(function(heading, i) {
          if (!heading.id) {
            heading.id = 'heading-' + i;
          }
        });
        headings.forEach(function(heading) {
          var level = parseInt(heading.tagName.substring(1));
          var li = document.createElement('li');
          li.style.marginLeft = (level - 1) * 15 + 'px';
          var a = document.createElement('a');
          a.href = '#' + heading.id;
          a.textContent = heading.textContent;
          a.style.color = '#555';
          a.style.textDecoration = 'none';
          a.onmouseover = function() { a.style.textDecoration = 'underline'; };
          a.onmouseout = function() { a.style.textDecoration = 'none'; };
          li.appendChild(a);
          tocList.appendChild(li);
        });
      })();
    </script>
  </body>
</html>
